<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>360 Web Tour Maker</title>
		<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
		
		<link rel="stylesheet" type="text/css" href="css/font-awesome.css">
		<link rel="stylesheet" type="text/css" href="style.css">
		
		<!-- Insert this line above script imports  -->
		<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
				
		<script src="jquery.js"></script>
		
		<!-- Insert this line after script imports -->
		<script>if (window.module) module = window.module;</script>
		
		<script>
			var projectext = ".wtm";
			const { dialog, BrowserWindow } = require('electron').remote;
			const { ipcRenderer } = require('electron');
			const fs = require('fs');
		</script>
		
	</head>
	
	<body>
	
		<div id="appbar">
			<div class="abitem">
				File
				<div class="dropdown-content">
					<div class="subabitem" onclick="showpage('projects')"><i class="fa fa-briefcase" style="width: 30px;"></i> Projects</div>
					<div class="subabitem" onclick="quitprogram()"><i class="fa fa-window-close" style="width: 30px;"></i> Exit</div>
				</div>
			</div>
			<div class="abitem">
				About
				<div class="dropdown-content">
					<div class="subabitem"><i class="fa fa-question" style="width: 30px;"></i> What is 360 Web Tour Maker</div>
					<div class="subabitem" onclick="showpage('versioninfo')"><i class="fa fa-info" style="width: 30px;"></i> Version Info</div>
					<div class="subabitem"><i class="fa fa-dollar" style="width: 30px;"></i> Support the Development</div>
				</div>
			</div>
			<div style="float: right;">
				<div class="abitem" onclick="minimize()"><i class="fa fa-window-minimize"></i></div>
				<div class="abitem minmaxbutton" onclick="maximize()"><i class="fa fa-window-restore"></i></div>
				<div class="abitem closebutton" onclick="quitprogram()"><i class="fa fa-window-close"></i></div>
			</div>
		</div>
		
		<!-- Version Info -->
		<div class="page" id="versioninfo">
			<h1>Version Info</h1>
			<h3>Version 1.0.0</h3>
			<p>12/29/2020 The very first release.</p>
		</div>
		
		<!-- Projects -->
		<div class="page" id="projects">
			<div style="display: table; width: 100%; table-layout: fixed;">
				<div style="display: table-cell; vertical-align: top; width: 30%; overflow-x: hidden;">
					<h4><i class="fa fa-pencil"></i> Create New Project</h4>
					<div>
						<p style="font-size: 12px; font-style: italic;">1. Project Name</p>
						<input id="newprojectname" placeholder="Give it a name">
					</div>
					<div>
						<p style="font-size: 12px; font-style: italic;">2. Project Directory</p>
						<p id="newprojectdir"></p>
						<button onclick="chooseprojectdir()">Browse</button>
					</div>
					<div>
						<p style="font-size: 12px; font-style: italic;">3. Hit Create Button!</p>
						<button onclick="createproject()">Create</button>
					</div>
					
					<h4><i class="fa fa-folder"></i> Or Open Existing Project</h4>
					<div>
						<p style="font-size: 12px; font-style: italic;">Click to browse</p>
						<button onclick="openproject()">Browse</button>
					</div>
					<script>
						var newprojectname = "";
						var newprojectdir = "";
						function chooseprojectdir(){
							newprojectname = $("#newprojectname").val();
							if(newprojectname != ""){
								dialog.showOpenDialog({
									properties: ['openDirectory']
								}).then(result => {
									newprojectdir = result.filePaths[0];
									if(newprojectdir != undefined){
										$("#newprojectdir").html(newprojectdir);
									}else{
										$("#newprojectdir").html("");
									}
								});
							}else{
								showAlert("Incomplete Information", "Enter your Project Name first, then specify the directory.");
								$("#newprojectname").focus();
								
							}
							
						}
						
						function openproject(){
							var openedprojectdir = "";
							dialog.showOpenDialog({
								properties: ['openDirectory']
							}).then(result => {
								openedprojectdir = result.filePaths[0];
								if(openedprojectdir != undefined){
									//showAlert("Open Project", "Is this correct: " + openedprojectdir + " ?");
									//Try to get the WTMProject.wtm file
									if(fs.existsSync(openedprojectdir + "\\WTMProject.wtm")){
										fs.readFile(openedprojectdir + "\\WTMProject.wtm", 'utf8', function (err,data) {
											if (err) {
												showAlert("Open Project", "This is NOT a valid project.");
												return console.log(err);
											}
											var openedprojecttitle = JSON.parse(data).title;
											openedprojectdir = openedprojectdir.replace(/\\/g, "/");
											
											if(isProjectExist(openedprojecttitle, openedprojectdir)){
												showAlert("Open Project", "This project already exists in Recent Projects list.");
											}else{
												//showAlert("Open Project", "Project has been successfully added to Recent Projects list.");
												wtmdata.projects.push({
													projectdir : openedprojectdir,
													projectname : openedprojecttitle,
												});
												saveWtmdata();
												loadRecentProjects();
											}
										});
									}else{
										showAlert("Open Project", "This is NOT a valid project.");
									}
								}
							});
						}
						
						function createproject(){
						
							if(newprojectname == "" && newprojectdir == ""){
								showAlert("Incomplete Information", "Both Project Name and Project Directory must be set.");
								$("#newprojectname").focus();
							}else{
							
								if(fs.existsSync(newprojectdir + "\\WTMProject.wtm")){
									showAlert("Invalid Directory", "This directory has been used for another project. Please choose another directory.");
								}else{
									showDim("Please Wait...");
								
									setTimeout(function(){
										var initialProjectData = {
											"title" : newprojectname,
										};
										fs.writeFile(newprojectdir + "/WTMProject" + projectext, JSON.stringify(initialProjectData), function (err) {
											if (err) return console.log(err);
											console.log('Tadaaaa! New project is created!');
											
											const fse = require("fs-extra");
											const srcDir = "./resources/panotemplate";
											const destDir = newprojectdir;
											fse.copySync(srcDir, destDir);
											
										});
										
										//Renaming project title
										setTimeout(function(){
											fs.readFile(newprojectdir + "/index.html", 'utf8', function (err, data) {
												if (err) { return console.log(err); }
												newhtml = data;
												var newhtml = data.replace("<title>TITLE</title>", "<title>" +newprojectname+ "</title>");
												fs.writeFile(newprojectdir + "/index.html", newhtml, function (err) {
													if (err) return console.log(err);
													console.log('Project title is set!');		

													//Preview the Project
													previewProject(newprojectdir.replace(/\\/g, "/") + "/index.html");
													
													wtmdata.projects.push({ 
														projectdir : newprojectdir.replace(/\\/g, "/"),
														projectname : newprojectname
													});
													saveWtmdata();
													loadRecentProjects();
													
													hideDim();
													
													$("#newprojectname").val("").focus();
													$("#newprojectdir").html("");
													newprojectname = "";
													newprojectdir = "";
													
												});
											});
										}, 3000);
									}, 1000);
								}
								
							}
						}
					</script>
				</div>
				
				<div style="display: table-cell; vertical-align: top; padding: 20px;">
					<h4><i class="fa fa-briefcase"></i> Recent Projects</h4>
					<div id="recentprojects"></div>
				</div>
				
			</div>
			
		</div>
		
		
		<div id="dim">
			<div style="display: table-cell; vertical-align: middle; text-align: center;">
				<div class="lds-hourglass" id="loading"></div>
				<h3 id="dimmessage"></h3>
			</div>
		</div>
		
		<script>

			var wtmdata = {
				projects : [],
			};
			
			if(localStorage.getItem("wtmdata") === null){
				saveWtmdata();
			}else{
				loadWtmdata();
			}
			
			function saveWtmdata(){
				localStorage.setItem("wtmdata", JSON.stringify(wtmdata));
			}
			
			function loadWtmdata(){
				wtmdata = JSON.parse(localStorage.getItem("wtmdata"));
			}
			
			function loadRecentProjects(){
				$("#recentprojects").html("");
				if(wtmdata.projects.length > 0){
					for(var i = 0; i < wtmdata.projects.length; i++){
						if (fs.existsSync(wtmdata.projects[i].projectdir)) {
							$("#recentprojects").prepend("<div class='projectlist'><div onclick=previewProject('" + wtmdata.projects[i].projectdir + "/index.html') style='cursor: pointer;'><div style='font-size: 20px;'>" +wtmdata.projects[i].projectname+ "</div><div style='font-size: 12px; color: #eba576;'>" +wtmdata.projects[i].projectdir+ "</div></div><div class='button' style='margin-bottom: 0px; font-size: 10px;' onclick=removeFromProjectList(" +i+ ")><i class='fa fa-trash'></i> Remove from list</div><div class='button' style='margin-bottom: 0px; font-size: 10px;' onclick=showInExplorer('" +wtmdata.projects[i].projectdir+ "')><i class='fa fa-folder'></i> Show in Explorer</div></div>");
						}else{
							$("#recentprojects").prepend("<div class='projectlist'><div style='color: #e76d6d; font-style: italic;'><div style='font-size: 20px;'><i class='fa fa-warning'></i> " +wtmdata.projects[i].projectname+ " (Not Found)</div><div style='font-size: 12px; color: #e76d6d;'>" +wtmdata.projects[i].projectdir+ "</div></div><div class='button' style='margin-bottom: 0px; font-size: 10px;' onclick=removeFromProjectList(" +i+ ")><i class='fa fa-trash'></i> Remove from list</div></div>");
						}
					}
					$("#recentprojects").css({ "height" : (innerHeight - 75) + "px", "overflow" : "auto" });
				}else{
					$("#recentprojects").html("No project found.");
				}
			}
			
			function removeFromProjectList(index){
				wtmdata.projects.splice(index, 1);
				saveWtmdata();
				loadRecentProjects();
			}
			
			function showInExplorer(dir){
				console.log("Trying to open in dir: " + dir);
				require('child_process').exec('start "" ' + dir);
			}
			
			function isProjectExist(title, dir){
				for(var i = 0; i < wtmdata.projects.length; i++){
					if(wtmdata.projects[i].projectdir == dir && wtmdata.projects[i].projectname == title)
						return true;
				}
				return false;
			}
			
			loadRecentProjects();
			
			function previewProject(ppath){
				const newwin = new BrowserWindow({ width: 1280, height : 720, title : "Project Preview" });
				newwin.loadFile(ppath);
				newwin.removeMenu();
				newwin.webContents.openDevTools();
			}
			
			function hideDim(){
				$("#dim").fadeOut();
				$("#loading").hide();
				$("#dimmessage").hide();
			}
			
			function showDim(message){
				$("#dimmessage").html(message).show();
				$("#dim").fadeIn();
				$("#loading").show();
			}
			
			function showAlert(title, message){
				$("#dimmessage").html("<div style='width: 70%; max-width: 600px; margin: 0 auto;'><div style='background-color: #eba576; color: #3d4855; padding: 10px;'><i class='fa fa-info'></i> " +title+ "</div><div style='padding: 30px; background-color: #3d4855; font-size: 14px; font-weight: normal;'><div>" +message+ "</div><button onclick='hideDim()' style='margin-top: 20px; margin-bottom: 0px;'>Close</button></div></div>");
				$("#dim").fadeIn();
				$("#loading").hide();
			}
			
			hideDim();
			
			function quitprogram(){
				console.log("Metusik");
				ipcRenderer.send("quitprogram");
			}
			
			function minimize(){
				var currentWindow = BrowserWindow.getFocusedWindow();
				currentWindow.minimize();
			}
			
			function maximize(){
				var window = BrowserWindow.getFocusedWindow();
				if(window.isMaximized()){ 
					window.unmaximize(); 
					$(".minmaxbutton").html("<i class='fa fa-window-maximize'></i>");
				}else{ 
					window.maximize(); 
					$(".minmaxbutton").html("<i class='fa fa-window-restore'></i>");
				}
			}
			
			function showpage(pid){
				$(".page").hide();
				$("#" + pid).show();
				
				switch(pid){
					case "projects" :
						loadRecentProjects();
						break;
				}
			}
			
			
			//click unclick menu blahblah
			$(".dropdown-content").on("click", function(){
				$(".dropdown-content", this).hide();
				topmenuclicked = false;
			});
			
			var topmenuclicked = false;
			$(".abitem").on("click", function(){
				$(".dropdown-content").hide();
				if(!topmenuclicked){
					$(".dropdown-content", this).show();
					topmenuclicked = true;
				}else{
					topmenuclicked = false;
				}
			});
			
			$(".abitem").hover(function(){
				$(".dropdown-content").hide();
				$(this).css({ "background-color" : "#232c37" });
				if(topmenuclicked){
					$(".dropdown-content", this).show();
				}
			},function(){
				$(".dropdown-content").hide();
				$(this).css({ "background-color" : "#2c3643" });
			});
			
			$(".closebutton").hover(function(){
				$(this).css({ "background-color" : "red" });
			}, function(){
				$(this).css({ "background-color" : "#2c3643" });
			});
			
			$(".minmaxbutton").hover(function(){
				$(this).css({ "background-color" : "#0d9e59" });
			}, function(){
				$(this).css({ "background-color" : "#2c3643" });
			});
			
			$(".page").on("click", function(){
				topmenuclicked = false;
			});
			
			showpage("projects");
			
		</script>
		
	</body>
</html>