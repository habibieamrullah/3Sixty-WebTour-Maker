<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>360 Web Tour Maker</title>
		<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
		
		<link rel="stylesheet" type="text/css" href="css/font-awesome.css">
		<link rel="stylesheet" type="text/css" href="style.css">
		
		<!-- Insert this line above script imports  -->
		<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
				
		<script src="jquery.js"></script>
		
		<!-- Insert this line after script imports -->
		<script>if (window.module) module = window.module;</script>
		
		<script>
			var projectext = ".wtm";
			const { dialog, BrowserWindow } = require('electron').remote;
			const { ipcRenderer } = require('electron');
			const fs = require('fs');
			const fse = require("fs-extra");
		</script>
		
	</head>
	
	<body style="display: none;">
		<div id="appbar">
			<div class="abitem">
				File
				<div class="dropdown-content">
					<div class="subabitem" onclick="showpage('projects')"><i class="fa fa-briefcase" style="width: 30px;"></i> Projects</div>
					<div class="subabitem" onclick="quitprogram()"><i class="fa fa-times" style="width: 30px;"></i> Exit</div>
				</div>
			</div>
			<div class="abitem">
				Help
				<div class="dropdown-content">
					<div class="subabitem" onclick="showMiniPage('donate')"><i class="fa fa-dollar" style="width: 30px;"></i> Support The Development</div>
					<div class="subabitem" onclick="showMiniPage('about')"><i class="fa fa-question" style="width: 30px;"></i> About 360 Web Tour Maker</div>					
				</div>
			</div>
			<div style="float: right;">
				<div class="abitem rightbtn minimizebutton" onclick="minimize()"><i class="fa fa-window-minimize"></i></div>
				<div class="abitem rightbtn minmaxbutton" onclick="maximize()"><i class="fa fa-window-restore"></i></div>
				<div class="abitem rightbtn closebutton" onclick="quitprogram()"><i class="fa fa-times"></i></div>
			</div>
		</div>
		
		<!-- Donate -->
		<div class="page" id="donate">
			<h1>Support The Development</h1>
			<p>This software is made for you for free. However, I expect any amount donations from users like you to keep me supported for maintenance and further development of this software.</p>
			<p>Please send your donation to my PayPal account here: <a href="https://paypal.me/habibieamrullah">https://paypal.me/habibieamrullah</a></p>
		</div>
		
		<!-- What is -->
		<div class="page" id="whatis">
			<h1>What is 360 Web Tour Maker</h1>
			<p>360 Web Tour Maker is a 100% free desktop software built for you to make a 360 panorama virtual tour for web.</p>
			<p>This software is made with so many wonderful open source technologies such as HTML5, JavaScript, jQuery, three.js, panolens and so on.</p>
		</div>
		
		<!-- Projects -->
		<div class="page" id="projects">
			<h1>Projects</h1>
			<div style="display: table; width: 100%; table-layout: fixed;">
				<div style="display: table-cell; vertical-align: top; width: 30%; overflow-x: hidden;">
					<h4><i class="fa fa-pencil"></i> Create New Project</h4>
					<div>
						<p style="font-size: 12px; font-style: italic;">1. Project Name</p>
						<input id="newprojectname" placeholder="Give it a name">
					</div>
					<div>
						<p style="font-size: 12px; font-style: italic;">2. Project Directory</p>
						<p id="newprojectdir"></p>
						<button onclick="chooseprojectdir()"><i class="fa fa-folder"></i> Browse</button>
					</div>
					<div>
						<p style="font-size: 12px; font-style: italic;">3. Hit Create Button!</p>
						<button onclick="createproject()"><i class="fa fa-chevron-right"></i> Create</button>
					</div>
					
					<h4><i class="fa fa-folder"></i> Or Open Existing Project</h4>
					<div>
						<p style="font-size: 12px; font-style: italic;">Click to browse</p>
						<button onclick="openproject()"><i class="fa fa-folder"></i> Browse</button>
					</div>
					<script>
						var newprojectname = "";
						var newprojectdir = "";
						function chooseprojectdir(){
							newprojectname = $("#newprojectname").val();
							if(newprojectname != ""){
								dialog.showOpenDialog({
									properties: ['openDirectory']
								}).then(result => {
									newprojectdir = result.filePaths[0];
									if(newprojectdir != undefined){
										$("#newprojectdir").html(newprojectdir);
									}else{
										$("#newprojectdir").html("");
										newprojectdir = "";
									}
								});
							}else{
								showAlert("Incomplete Information", "Enter your Project Name first, then specify the directory.");
								$("#newprojectname").focus();
								
							}
							
						}
						
						function openproject(){
							var openedprojectdir = "";
							dialog.showOpenDialog({
								properties: ['openDirectory']
							}).then(result => {
								openedprojectdir = result.filePaths[0];
								if(openedprojectdir != undefined){
									//showAlert("Open Project", "Is this correct: " + openedprojectdir + " ?");
									//Try to get the WTMProject.wtm file
									if(fs.existsSync(openedprojectdir + "\\WTMProject.wtm")){
										fs.readFile(openedprojectdir + "\\WTMProject.wtm", 'utf8', function (err,data) {
											if (err) {
												showAlert("Open Project", "This is NOT a valid project.");
												return console.log(err);
											}
											var openedprojecttitle = JSON.parse(data).title;
											openedprojectdir = openedprojectdir.replace(/\\/g, "/");
											
											if(isProjectExist(openedprojecttitle, openedprojectdir)){
												showAlert("Open Project", "This project already exists in Recent Projects list.");
											}else{
												//showAlert("Open Project", "Project has been successfully added to Recent Projects list.");
												wtmdata.projects.push({
													projectdir : openedprojectdir,
													projectname : openedprojecttitle,
												});
												saveWtmdata();
												loadRecentProjects();
											}
										});
									}else{
										showAlert("Open Project", "This is NOT a valid project.");
									}
								}
							});
						}
						
						function createproject(){
							newprojectname = $("#newprojectname").val();
							if(newprojectname == "" || newprojectdir == ""){
								showAlert("Incomplete Information", "Both Project Name and Project Directory must be set.");
								$("#newprojectname").focus();
							}else{
							
								if(fs.existsSync(newprojectdir + "\\WTMProject.wtm")){
									showAlert("Invalid Directory", "This directory has been used for another project. Please choose another directory.");
								}else{
									showDim("Please Wait...");
								
									setTimeout(function(){
										var initialProjectData = {
											"title" : newprojectname,
											"panoramas" : [ { panofile : "testpanorama.jpg", hotspots : [] }],
											"settings" : {
												"loadingtext" : "Loading...",
												"firstpanorama" : "testpanorama.jpg",
											},
										};
										currentprojectdata = initialProjectData;
										fs.writeFile(newprojectdir + "/WTMProject" + projectext, JSON.stringify(initialProjectData), function (err) {
											if (err) return console.log(err);
											console.log('Tadaaaa! New project is created!');

											const srcDir = "./resources/panotemplate";
											const destDir = newprojectdir;
											fse.copySync(srcDir, destDir);
											
										});
										
										//Preparing initial HTML
										setTimeout(function(){
											fs.readFile(newprojectdir + "/index.html", 'utf8', function (err, data) {
												if (err) { return console.log(err); }
												newhtml = data;
												var newhtml = data.replace("<title>TITLE</title>", "<title>" +newprojectname+ "</title>");
												data = newhtml;
												var newhtml = data.split("/*panoramas*/")[0] +"/*panoramas*/\n\r"+ generatePanoramas(initialProjectData.panoramas) +"\n\r/*panoramas-end*/"+ data.split("/*panoramas-end*/")[1];
												fs.writeFile(newprojectdir + "/index.html", newhtml, function (err) {
													if (err) return console.log(err);
													console.log('Project title is set!');		
													
													wtmdata.projects.push({ 
														projectdir : newprojectdir.replace(/\\/g, "/"),
														projectname : newprojectname
													});
													
													saveWtmdata();
													loadRecentProjects();
													
													//Preview the Project
													editproject(wtmdata.projects.length-1);
													
													hideDim();
													
													$("#newprojectname").val("").focus();
													$("#newprojectdir").html("");
													newprojectname = "";
													newprojectdir = "";
													
												});
											});
										}, 3000);
									}, 1000);
								}
								
							}
						}
					</script>
				</div>
				<div style="display: table-cell; vertical-align: top; padding-left: 20px;">
					<h4><i class="fa fa-briefcase"></i> Recent Projects</h4>
					<div id="recentprojects"></div>
				</div>
			</div>			
		</div>
		
		<!-- Project Editor -->
		<div class="page" id="projecteditor">
			<div style="display: table; width: 100%; table-layout: fixed;">
				<div style="display: table-cell; vertical-align: top; width: 50px; vertical-align: middle;">
					<a href="#" onclick="showpage('projects')"><i class="fa fa-chevron-left" style="font-size: 30px;"></i></a>
				</div>
				<div style="display: table-cell; vertical-align: top;">
					<div style="font-size: 20px;"><i class="fa fa-briefcase" style="width: 20px;"></i> <input id="currentprojecttitle" style="display: inline-block; width: 300px; color: #cccccc; font-size: 20px; font-weight: normal; margin-bottom: 5px; border: none;"onkeyup="renamecurrentproject()"></div>
					<p id="currentprojectdir" style='font-size: 12px; color: #eba576; font-style: italic; cursor: pointer;'></p>
				</div>
				<div style="display: table-cell; vertical-align: middle; width: 100px; text-align: right;">
					<div class="greenbutton" style="margin: 0px; padding: 10px; font-size: 12px;" id="currentprojectrunbutton"><i class="fa fa-play"></i></div>
				</div>
			</div>
			<div style="display: table; width: 100%; table-layout: fixed; margin-top: 30px;">
				<div style="display: table-cell; vertical-align: top; width: 200px; overflow-x: hidden;">
					<div class="editortab" onclick="showeditorc('panoramas')"><i class="fa fa-camera" style="width: 20px;"></i> Panoramas</div>
					<div class="editortab" onclick="showeditorc('hotspots')"><i class="fa fa-circle-thin" style="width: 20px;"></i> Hotspots</div>
					<div class="editortab" onclick="showeditorc('imageassets')"><i class="fa fa-image" style="width: 20px;"></i> Image Assets</div>
					<div class="editortab" onclick="showeditorc('settings')"><i class="fa fa-cog" style="width: 20px;"></i> Settings</div>
				</div>
				<div style="display: table-cell; vertical-align: top; padding-left: 20px;">
					<div id="editorcontent" style="height: 400px; overflow: auto;"></div>
				</div>
			</div>
		</div>
		
		<!-- loading and alert dim -->
		<div id="dim">
			<div style="display: table-cell; vertical-align: middle; text-align: center;">
				<div class="lds-hourglass" id="loading"></div>
				<h3 id="dimmessage"></h3>
			</div>
		</div>
		
		<!-- top menu dim -->
		<div id="topmenudim"></div>
		
		<script>

			var wtmdata = {
				projects : [],
			};
			
			if(localStorage.getItem("wtmdata") === null){
				saveWtmdata();
			}else{
				loadWtmdata();
			}
			
			function saveWtmdata(){
				localStorage.setItem("wtmdata", JSON.stringify(wtmdata));
			}
			
			function loadWtmdata(){
				wtmdata = JSON.parse(localStorage.getItem("wtmdata"));
			}
			
			function loadRecentProjects(){
				$("#recentprojects").html("");
				if(wtmdata.projects.length > 0){
					for(var i = 0; i < wtmdata.projects.length; i++){
						if (fs.existsSync(wtmdata.projects[i].projectdir)) {
							
							$("#recentprojects").prepend("<div class='projectlist'><div style='cursor: pointer;' onclick='editproject("+i+")'><div style='font-size: 20px;'>" +wtmdata.projects[i].projectname+ "</div><div style='font-size: 12px; color: #eba576;'>" +wtmdata.projects[i].projectdir+ "</div></div><div class='greenbutton' style='margin-bottom: 0px; font-size: 10px;' onclick=previewProject("+i+")><i class='fa fa-play'></i> Run</div><div class='button' style='margin-bottom: 0px; font-size: 10px;' onclick=showInExplorer(" +i+ ")><i class='fa fa-folder'></i> Show in Explorer</div><div class='redbutton' style='margin-bottom: 0px; font-size: 10px;' onclick=removeFromProjectList(" +i+ ")><i class='fa fa-trash'></i> Remove from list</div></div>");
							
						}else{
							
							$("#recentprojects").prepend("<div class='projectlist'><div style='color: #e76d6d; font-style: italic;'><div style='font-size: 20px;'><i class='fa fa-warning'></i> " +wtmdata.projects[i].projectname+ " (Not Found)</div><div style='font-size: 12px; color: #e76d6d;'>" +wtmdata.projects[i].projectdir+ "</div></div><div class='redbutton' style='margin-bottom: 0px; font-size: 10px;' onclick=removeFromProjectList(" +i+ ")><i class='fa fa-trash'></i> Remove from list</div></div>");
							
						}
					}
					$(".projectlist").hide();
					var num = 0;
					$(".projectlist").each(function(){
						$(".projectlist").eq(num).delay(num * 100).fadeIn();
						num++;
					});
					limitHeight();
				}else{
					$("#recentprojects").html("No project found.");
				}
			}
			
			function removeFromProjectList(index){
				showYesNoAlert("Are you sure?", "Remove this project from the Project list? You will need to remove the directory from your hard drive manually to completely delete it from your computer.", function(){
					wtmdata.projects.splice(index, 1);
					saveWtmdata();
					loadRecentProjects();
				});
			}
			
			function showInExplorer(idx){
				
				var dir = wtmdata.projects[idx].projectdir;
				
				if(dir.indexOf(" ") > -1){
					showAlert("White Space Problem", "This project folder contains white space(s). Please manually explore and find it on your computer:<br>" + dir);
				}else{
					console.log("Trying to open in dir: " + dir);
					require('child_process').exec('start "" ' + dir);
				}
			}
			
			function isProjectExist(title, dir){
				for(var i = 0; i < wtmdata.projects.length; i++){
					// && wtmdata.projects[i].projectname == title
					if(wtmdata.projects[i].projectdir == dir)
						return true;
				}
				return false;
			}
			
			loadRecentProjects();
			
			function previewProject(idx){
				var ppath = wtmdata.projects[idx].projectdir + "/index.html";
				var newwin = new BrowserWindow({ width: 1280, height : 720, title : "Project Preview" });
				newwin.loadFile(ppath);
				newwin.removeMenu();
				newwin.webContents.openDevTools();
			}
			
			function generatePanoramas(arr){
				var pdata = "";
				if(arr.length > 0){
					for(var i = 0; i < arr.length; i++){
						var panovar = arr[i].panofile.split(".")[0];
						pdata += "var "+panovar+" = new PANOLENS.ImagePanorama( \"panoramas/" + arr[i].panofile + "\" );\n\
						viewer.add( "+panovar+" );\n\
						"+panovar+".addEventListener('progress', function(e){\n\
							$(\"#loading\").show();\n\
						});\n\
						"+panovar+".addEventListener('load', function(e){\n\
							$(\"#loading\").fadeOut();\n\
						});\n\
						"+panovar+".addEventListener('click', function(e){\n\
						});\n\r\n\r";
						console.log("JS Code for this panorama has been added: " + panovar);
					}
					
					pdata += "viewer.setPanorama( "+currentprojectdata.settings.firstpanorama.split(".")[0]+" );\n";
				}
				return pdata;
			}
			
			function hideDim(){
				$("#dim").fadeOut();
				$("#loading").hide();
			}
			
			function showDim(message){
				$("#dimmessage").html(message);
				$("#dim").fadeIn();
				$("#loading").show();
			}
			
			function showAlert(title, message){
				$("#dimmessage").html("<div style='width: 70%; max-width: 400px; margin: 0 auto;'><div style='background-color: #2c3643; color: white; padding: 10px;'><i class='fa fa-info-circle'></i> " +title+ "</div><div style='padding: 30px; background-color: #3d4855; font-size: 14px; font-weight: normal;'><div>" +message+ "</div><button onclick='hideDim()' style='margin-top: 20px; margin-bottom: 0px;'>Close</button></div></div>");
				$("#dim").show();
				$("#loading").hide();
			}
			
			var doit;
			function showYesNoAlert(title, message, fn){
				$("#dimmessage").html("<div style='width: 70%; max-width: 400px; margin: 0 auto;'><div style='background-color: #2c3643; color: white; padding: 10px;'><i class='fa fa-question-circle'></i> " +title+ "</div><div style='padding: 30px; background-color: #3d4855; font-size: 14px; font-weight: normal;'><div>" +message+ "</div><button onclick='doit(); hideDim();' style='margin-top: 20px; margin-bottom: 0px; margin-right: 10px;'>Yes</button><button onclick='hideDim()' style='margin-left: 10px; margin-top: 20px; margin-bottom: 0px;'>No</button></div></div>");
				$("#dim").show();
				$("#loading").hide();
				
				doit = function(){
					fn();
				}
			}
			
			function showMiniPage(type){
				switch (type){
					case "about" :
						showAlert("About", "<h1>360 Web Tour Maker</h1><h3>Version 1.0.0</h3><p><br><a href='#' onclick=showMiniPage('donate')>Support The Development</a><br><a href='#'>Terms and Conditions</a><br><a href='https://ciihuy.com/'>Visit the Web</a></p>");
						break;
					case "donate" :
						showAlert("Support The Development", "<p><img src='paypal.png' style='background-color: white; padding: 20px;'></p><p>This software is made for you for free. However, I expect any amount donations from users like you to keep me supported for maintenance and further development of this software.</p><p>Please send your donation to my PayPal account here: <a href='https://paypal.me/habibieamrullah'>https://paypal.me/habibieamrullah</a></p>");
						break;
				}
			}
			
			hideDim();
			
			function quitprogram(){
				console.log("Metusik");
				ipcRenderer.send("quitprogram");
			}
			
			function minimize(){
				var currentWindow = BrowserWindow.getFocusedWindow();
				currentWindow.minimize();
			}
			
			function maximize(){
				var window = BrowserWindow.getFocusedWindow();
				if(window.isMaximized()){ 
					window.unmaximize(); 
					$(".minmaxbutton").html("<i class='fa fa-window-maximize'></i>");
				}else{ 
					window.maximize(); 
					$(".minmaxbutton").html("<i class='fa fa-window-restore'></i>");
				}
			}
			
			function showpage(pid){
				$(".page").hide();
				$("#" + pid).fadeIn();
				
				switch(pid){
					case "projects" :
						loadRecentProjects();
						break;
				}
			}
			
			//Function to generate random characters
			function randomblah(length){
				var result = '';
				var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
				var charactersLength = characters.length;
				for ( var i = 0; i < length; i++ ) {
				result += characters.charAt(Math.floor(Math.random() * charactersLength));
				}
				return result;
			}
			
			//Function to truncate string
			function truncate(str, n){
				return (str.length > n) ? str.substr(0, n-1) + '&hellip;' : str;
			};
			
			var currentprojectindex;
			var currentpanoramaindex;
			var currentprojectdata;
			function editproject(idx){
				currentprojectindex = idx;
				showpage("projecteditor");
				$("#currentprojecttitle").val(wtmdata.projects[idx].projectname);
				$("#currentprojectdir").html("<i class='fa fa-folder' style='width: 30px;'></i>" + wtmdata.projects[idx].projectdir).attr({ "onclick" : "showInExplorer(" + idx + ")" });
				$("#currentprojectrunbutton").attr({ "onclick" : "previewProject("+idx+")" });
				fs.readFile(wtmdata.projects[idx].projectdir + "/WTMProject.wtm", 'utf8', function (err, data) {
					if(err){
						showAlert("Project Corrupted", "Sorry this project can not be opened.");
						showpage("projects");
						return;
					}
					currentprojectdata = JSON.parse(data);
					showeditorc("panoramas");
				});
			}
			
			function showeditorc(type){
				switch(type){
					case "panoramas" :
						var panoramas = "<h2>Panorama Images</h2>";
						for(var i = 0; i < currentprojectdata.panoramas.length; i++){
							var itsmainpano = "";
							var itsmainpanogreen = "background-color: #eba576;";
							var itsmainpanoaction = " onclick='setitasmainpano(" +i+ ")'";
							var itsmainpanotrash = "";
							if(currentprojectdata.panoramas[i].panofile == currentprojectdata.settings.firstpanorama){
								itsmainpano = "<i class='fa fa-home'></i> ";
								itsmainpanogreen = "background-color: #0d9e59;";
								itsmainpanoaction = " onclick='showAlert(\"Main Panorama\", \"This panorama is already set as Main Panorama\");'";
								itsmainpanotrash = " display: none;";
							}
							panoramas += "<div class='imgthumb' style='position: relative; background: url(" + wtmdata.projects[currentprojectindex].projectdir + "/panoramas/" + currentprojectdata.panoramas[i].panofile + ") no-repeat center center; background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover;'><span"+itsmainpanoaction+" style='"+itsmainpanogreen+" color: black; cursor: pointer; font-weight: bold; padding: 5px; font-size: 10px;'>" + itsmainpano + truncate(currentprojectdata.panoramas[i].panofile, 20) + "</span><div onclick='removePanorama(" +i+ ")' class='redbutton' style='" +itsmainpanotrash+ "position: absolute; bottom: 0; right: 0;'><i class='fa fa-trash'></i></div></div>";
						}
						$("#editorcontent").html(panoramas + "<div class='imgthumb' onclick='addpanorama()'><div style='cursor: pointer; display: table; width: 100%; height: 100%;'><div style='display: table-cell; text-align: center; vertical-align: middle;'><i class='fa fa-plus' style='font-size: 40px;'></i></div></div></div>");
						break;
					case "settings" :
						$("#editorcontent").html("<h2>Project Settings</h2><p>Default Tour Mode</p><select><option>Normal</option><option>Cardboard</option><option>Stereoscopic</option></select><p>Panorama Loading Text</p><input id='psloadingtext' value='" +currentprojectdata.settings.loadingtext+ "'><p>Main Panorama (First panorama to load)</p><select id='firstpanorama'>" +getPanoramasNameOption()+ "</select><p>Hide Panolens Control Buttons (bottom right)</p><select><option>Yes</option><option>No</option></select><button onclick='saveProjectSettings()'><i class='fa fa-floppy-o'></i> Save</button>");
						break;
					case "hotspots" :
						var panoswithhots = "";
						for(var i = 0; i < currentprojectdata.panoramas.length; i++){
							var hotspotsofit = "";
							if(currentprojectdata.panoramas[i].hotspots.length == 0){
								hotspotsofit = "<div>There is no hotspot for this panorama.</div>";
							}else{
								for(var x = 0 ; x < currentprojectdata.panoramas[i].hotspots.length; x++){
									hotspotsofit += "<div class='hotspotholder'><div class='hotspottitle'><input value='" +currentprojectdata.panoramas[i].hotspots[x]+ "'></div><div><button>Add Action</button><button class='redbutton'>Remove</button></div></div>";
								}
							}
							
							hotspotsofit = "<div>" + hotspotsofit + "</div>";
							
							panoswithhots += "<div style='background: url(" + wtmdata.projects[currentprojectindex].projectdir + "/panoramas/" + currentprojectdata.panoramas[i].panofile + ") no-repeat center center; background-size: cover; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; margin-bottom: 20px; margin-right: 20px;'><div class='brighteronhover' style='padding: 20px;'><div style='border: 2px solid white; color: white; padding: 10px; display: inline-block; margin-bottom: 10px;'>" +currentprojectdata.panoramas[i].panofile+ "</div>" + hotspotsofit + "<button style='margin: 0px; margin-top: 10px;' class='greenbutton' onclick=addNewHotspotFor("+i+")><i class='fa fa-plus-square'></i> Add</button></div></div>";
						}
						$("#editorcontent").html("<h2>Hotspots</h2>" + panoswithhots);
						break;
						
					case "imageassets" :
						$("#editorcontent").html("<h2>Image Assets</h2><p>Image assets will be here</p>");
				}
				
				limitHeight();
			}
			
			function addNewHotspotFor(idx){
				currentpanoramaindex = idx;
				var hotpath = "./hotspotmaker.html";
				var panofile = currentprojectdata.panoramas[idx].panofile;
				var panoname = panofile.split(".")[0];
				//Let's copy current panorama file to temp panorama directory
				fse.copySync(wtmdata.projects[currentprojectindex].projectdir + "/panoramas/" + panofile, './temp/' + panofile);
				fs.readFile(hotpath, 'utf8', function (err, data) {
					if (err) { return console.log(err); }
					var newhtml = data.split("/*panoramas*/")[0] +"/*panoramas*/\n\r" + 
					"var "+panoname+" = new PANOLENS.ImagePanorama( \"temp/" + panofile + "\" );\n" +
						"viewer.add( "+panoname+" );\n" +
						panoname+".addEventListener('progress', function(e){\n" +
							"$(\"#loading\").show();\n" +
						"});\n" + 
						panoname+".addEventListener('load', function(e){\n" +
							"$(\"#loading\").fadeOut();\n" + 
						"});\n" + 
						panoname+".addEventListener('click', function(e){\n" +
						"});\n\r\n\r" +
					"\n\r/*panoramas-end*/" + data.split("/*panoramas-end*/")[1];
					fs.writeFile(hotpath, newhtml, function (err) {
						if (err) return console.log(err);
						
						var hoteditor = new BrowserWindow({ 
							width: 1280, 
							height : 720, 
							title : "Add New Hotspot", 
							webPreferences : { 
								nodeIntegration: true,
								enableRemoteModule: true,
							} 
						});
						hoteditor.loadFile(hotpath);
						hoteditor.removeMenu();
						
						//hoteditor.webContents.openDevTools();
					});
				});
			}
			
			function setitasmainpano(idx){
				currentprojectdata.settings.firstpanorama = currentprojectdata.panoramas[idx].panofile;
				updateWtmFile();
				fs.readFile(wtmdata.projects[currentprojectindex].projectdir + "/index.html", 'utf8', function (err, data) {
					if (err) { return console.log(err); }
					var newhtml = data.split("/*panoramas*/")[0] +"/*panoramas*/\n\r"+ generatePanoramas(currentprojectdata.panoramas) +"\n\r/*panoramas-end*/"+ data.split("/*panoramas-end*/")[1];
					fs.writeFile(wtmdata.projects[currentprojectindex].projectdir + "/index.html", newhtml, function (err) {
						if (err) return console.log(err);
						showeditorc("panoramas");
					});
				});
			}
			
			function saveProjectSettings(){
				var newtitle = $("#psloadingtext").val();
				var firstpanorama = $("#firstpanorama").val();
				currentprojectdata.settings = {
					loadingtext : newtitle,
					firstpanorama : firstpanorama,
				};
				updateWtmFile();
				fs.readFile(wtmdata.projects[currentprojectindex].projectdir + "/index.html", 'utf8', function (err, data) {
					if (err) { return console.log(err); }
					var newhtml = data.split("<!--loadingtext--\>")[0] +"<!--loadingtext--\>"+ newtitle +"<!--loadingtext-end--\>"+ data.split("<!--loadingtext-end--\>")[1];
					newhtml = newhtml.split("/*panoramas*/")[0] +"/*panoramas*/\n\r"+ generatePanoramas(currentprojectdata.panoramas) +"\n\r/*panoramas-end*/"+ data.split("/*panoramas-end*/")[1];
					fs.writeFile(wtmdata.projects[currentprojectindex].projectdir + "/index.html", newhtml, function (err) {
						if (err) return console.log(err);
						showAlert("Project Settings", "Project Settings has been updated successfully.");
						
					});
				});
			}
			
			function getPanoramasNameOption(){
				op = "";
				for(var i = 0; i < currentprojectdata.panoramas.length; i++){
					var panname = currentprojectdata.panoramas[i].panofile;
					if(panname == currentprojectdata.settings.firstpanorama)
						op += "<option selected='selected' value='"+panname+"'>" +panname+ "</option>";
					else
						op += "<option value='"+panname+"'>" +panname+ "</option>";
				}
				return op;
				
			}
			
			function addpanorama(){
				var newpanoramapath = "";
				dialog.showOpenDialog({
					properties: ['openFile'],
					filters : [{
						name : 'Images', extensions : ['jpg', 'gif'],
					}]
				}).then(result => {
					//Get the new panorama file path
					newpanoramapath = result.filePaths[0];
					if(newpanoramapath != undefined){
						console.log(newpanoramapath);
						//Renaming the file to better file name
						var newpanoramafile = newpanoramapath.split("\\")[newpanoramapath.split("\\").length-1];
						newpanoramafile = newpanoramafile.replace(/\s+/g, '').toLowerCase();
						//Checking duplicate file name to avoid conflicts
						if(foundduplicatepanofile(newpanoramafile))
							newpanoramafile = newpanoramafile.split(".")[0] + randomblah(5) + "." + newpanoramafile.split(".")[1];
						console.log("Selected file: " + newpanoramafile);
						//Copying new panorama image to project image directory
						fse.copySync(newpanoramapath, wtmdata.projects[currentprojectindex].projectdir + '/panoramas/' + newpanoramafile);
						console.log("New panorama file copied to project directory.");
						//Pushing new panorama file name to projectdata
						currentprojectdata.panoramas.push({ panofile : newpanoramafile, hotspots : [] });
						//Write new projectdata to wtm file
						updateWtmFile();
						//Regenerate html panoramas
						generateHTMLPanoramas();
					}
				});
			}
			
			//Generating html for panorama changes
			function generateHTMLPanoramas(){
				fs.readFile(wtmdata.projects[currentprojectindex].projectdir + "/index.html", 'utf8', function (err, data) {
					if (err) { return console.log(err); }
					var newhtml = data.split("/*panoramas*/")[0] +"/*panoramas*/\n\r"+ generatePanoramas(currentprojectdata.panoramas) +"\n\r/*panoramas-end*/"+ data.split("/*panoramas-end*/")[1];
					fs.writeFile(wtmdata.projects[currentprojectindex].projectdir + "/index.html", newhtml, function (err) {
						if (err) return console.log(err);
						showeditorc('panoramas');
						console.log("Done regenerating new HTML after adding new panorama.");
					});
				});
			}
			
			//To remove panorama
			function removePanorama(idx){
				showYesNoAlert("Remove this Panorama?", "Do you want to remove this panorama? You will also lost all the hotspots inside it.", function(){
					if(currentprojectdata.panoramas[idx].panofile == currentprojectdata.settings.firstpanorama){
						showAlert("Unable to Remove", "This panorama has been set as Main Panorama. You can not remove it unless you set another panorama file as Main Panorama.");
					}else{
						console.log("I choose to delete this panu, yeah!");
						console.log("So, remove this panu: " + currentprojectdata.panoramas[idx].panofile);
						deleteFile(wtmdata.projects[currentprojectindex].projectdir + "/panoramas/" + currentprojectdata.panoramas[idx].panofile);
						currentprojectdata.panoramas.splice(idx, 1);
						updateWtmFile();
						generateHTMLPanoramas();
						showeditorc("panoramas");
					}
				});
			}
			
			//FS delete file
			function deleteFile(f){
				try {
					fs.unlinkSync(f)
					//file removed
				} catch(err) {
					console.error(err)
				}
			}
			
			//A function to check is this file name is duplicated or not
			function foundduplicatepanofile(filename){
				for(var i = 0; i < currentprojectdata.panoramas.length; i++){
					if(filename == currentprojectdata.panoramas[i].panofile)
						return true;
				}
				return false;
			}
			
			//Update the WTM File of current project
			function updateWtmFile(){
				fs.writeFile(wtmdata.projects[currentprojectindex].projectdir + "/WTMProject.wtm", JSON.stringify(currentprojectdata), function (err,data){});
			}
			
			
			var rnmttltimeout;
			function renamecurrentproject(){
				var newtitle = $("#currentprojecttitle").val();
				if(newtitle.length > 3){
					clearTimeout(rnmttltimeout);
					rnmttltimeout = setTimeout(function(){
						//Read existing WTM data
						fs.readFile(wtmdata.projects[currentprojectindex].projectdir + "/WTMProject.wtm", 'utf8', function (err,data) {
							if (err) {
								return console.log(err);
							}
							var projectinfo = JSON.parse(data);
							projectinfo.title = newtitle;
							//Then replace the WTM data with the updated one
							fs.writeFile(wtmdata.projects[currentprojectindex].projectdir + "/WTMProject.wtm", JSON.stringify(projectinfo), function (err) {
								if (err) return console.log(err);
									//Then re-generate the HTML accordingly
									//First read the existing HTML content
									fs.readFile(wtmdata.projects[currentprojectindex].projectdir + "/index.html", 'utf8', function (err,data){
									if (err) {
										return false;
									}							
									//Then manipulate and place the new content
									var newhtml = data.split("<title>")[0] + "<title>" +newtitle+ "</title>" + data.split("</title>")[1];
									fs.writeFile(wtmdata.projects[currentprojectindex].projectdir + "/index.html", newhtml, function (err) {
										if (err) return console.log(err);
										//If everything is done, save it!
										wtmdata.projects[currentprojectindex].projectname = newtitle;
										saveWtmdata();
										showAlert("Project Title Change", "New project title has been updated.");
									});
								});
							});
						});
					},5000);
				}
			}
			
			
			//fuckin messy click unclick menu blahblah
			$(".subabitem").on("click", function(){
				setTimeout(function(){
					$(".dropdown-content", this).hide();
					topmenuclicked = false;
					$("#topmenudim").hide();
				},500);
			});
			
			var topmenuclicked = false;
			$(".abitem").on("click", function(){
				$(".dropdown-content").hide();
				if(!topmenuclicked){
					$(".dropdown-content", this).show();
					topmenuclicked = true;
					$("#topmenudim").show();
				}else{
					topmenuclicked = false;
					$("#topmenudim").hide();
				}
			});
			
			$("#topmenudim, .rightbtn").on("click", function(){
				$(".dropdown-content").hide();
				topmenuclicked = false;
				$("#topmenudim").hide();
				$(".abitem").css({ "background-color" : "#2c3643" });
			});
			
			$(".abitem").not(".rightbtn").hover(function(){
				$(".dropdown-content").hide();
				$(".abitem").css({ "background-color" : "#2c3643" });
				$(this).css({ "background-color" : "#232c37" });
				if(topmenuclicked){
					$(".dropdown-content", this).show();
				}
			},function(){
				if(!topmenuclicked){
					$(".dropdown-content").hide();
					$(this).css({ "background-color" : "#2c3643" });
				}
			});
			
			$(".closebutton").hover(function(){
				$(this).css({ "background-color" : "#cf0000" });
			}, function(){
				$(this).css({ "background-color" : "#2c3643" });
			});
			
			$(".minmaxbutton, .minimizebutton").hover(function(){
				$(this).css({ "background-color" : "#0d9e59" });
			}, function(){
				$(this).css({ "background-color" : "#2c3643" });
			});
			
			$(".page").on("click", function(){
				topmenuclicked = false;
			});
			
			showpage("projects");
			
			$(document).ready(function(){
				$("body").fadeIn();
			});
			
			
			function limitHeight(){
				$("#recentprojects").css({ "height" : (innerHeight - 75) + "px", "overflow" : "auto" });
				$("#editorcontent").css({ "height" : (innerHeight-200) + "px" });
			}
			
			$(window).resize(function(){
				limitHeight();
			});
			
			//Open link in external browser
			const shell = require('electron').shell;
			// assuming $ is jQuery
			$(document).on('click', 'a[href^="http"]', function(event) {
				event.preventDefault();
				shell.openExternal(this.href);
			});
			
			//Electron Bridge
			ipcRenderer.on("setnewinfospotlocation", (event, arg)=>{
				//showAlert("New Hotspot", "New Hotspot location added on this coordinates: " + arg.position);
				currentprojectdata.panoramas[currentpanoramaindex].hotspots.push({ title : arg.position, position : arg.position, actions : [] });
				updateWtmFile();
				showeditorc("hotspots");
			});
			
		</script>
		
	</body>
</html>