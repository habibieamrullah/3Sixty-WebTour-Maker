<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>3D Scene Visual Editor</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        
        #toolbar {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(44, 54, 67, 0.95);
            backdrop-filter: blur(5px);
            color: white;
            padding: 8px 15px;
            border-radius: 30px;
            display: flex;
            gap: 10px;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #eba576;
        }
        
        .tool-btn {
            background: #2c3643;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tool-btn:hover {
            background: #eba576;
            color: #2c3643;
        }
        
        .tool-btn.active {
            background: #0d9e59;
            color: white;
        }
        
        #object-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            width: 320px;
            background: rgba(44, 54, 67, 0.95);
            backdrop-filter: blur(5px);
            color: white;
            border-radius: 10px;
            padding: 15px;
            z-index: 100;
            border: 1px solid #eba576;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        #object-panel h3 {
            margin: 0 0 15px 0;
            color: #eba576;
            border-bottom: 1px solid #eba576;
            padding-bottom: 8px;
        }
        
        .object-list {
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .object-item {
            background: #3d4855;
            margin-bottom: 5px;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .object-item:hover {
            background: #4a5563;
        }
        
        .object-item.selected {
            border-color: #eba576;
            background: #4a5563;
        }
        
        .object-item .object-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2c3643;
            border-radius: 3px;
        }
        
        .object-item .object-info {
            flex: 1;
        }
        
        .object-item .object-name {
            font-weight: bold;
            font-size: 13px;
        }
        
        .object-item .object-type {
            font-size: 10px;
            color: #eba576;
        }
        
        .property-group {
            margin-bottom: 15px;
            background: #2c3643;
            padding: 12px;
            border-radius: 5px;
        }
        
        .property-group label {
            display: block;
            font-size: 12px;
            color: #eba576;
            margin-bottom: 5px;
        }
        
        .property-group input, .property-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid #3d4855;
            background: #1e262f;
            color: white;
            border-radius: 3px;
            margin-bottom: 8px;
        }
        
        .property-group input[type="color"] {
            height: 35px;
            padding: 2px;
        }
        
        .transform-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }
        
        .transform-controls input {
            text-align: center;
        }
        
        .btn {
            background: #2c3643;
            color: white;
            border: 1px solid #eba576;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .btn:hover {
            background: #eba576;
            color: #2c3643;
        }
        
        .btn-green {
            background: #0d9e59;
            border-color: #0d9e59;
        }
        
        .btn-green:hover {
            background: #0b8046;
            color: white;
        }
        
        .btn-red {
            background: #cf0000;
            border-color: #cf0000;
        }
        
        .btn-red:hover {
            background: #a50000;
            color: white;
        }
        
        .btn-blue {
            background: #0066cc;
            border-color: #0066cc;
        }
        
        .btn-blue:hover {
            background: #0052a3;
            color: white;
        }
        
        #status-bar {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #eba576;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
        }
        
        .gizmo {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(44, 54, 67, 0.9);
            color: white;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }
        
        .gizmo-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2c3643;
            border: 1px solid #eba576;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .gizmo-btn:hover, .gizmo-btn.active {
            background: #eba576;
            color: #2c3643;
        }
        
        .actions-panel {
            margin-top: 15px;
            border-top: 1px solid #eba576;
            padding-top: 15px;
        }
        
        .action-item {
            background: #1e262f;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .action-type {
            color: #eba576;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .action-target {
            background: #2c3643;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
        }
        
        .action-remove {
            color: #cf0000;
            cursor: pointer;
            margin-top: 5px;
            text-align: right;
            font-size: 11px;
        }
        
        .action-remove:hover {
            text-decoration: underline;
        }
        
        .hotspot-creator {
            position: fixed;
            top: 70px;
            left: 10px;
            background: rgba(44, 54, 67, 0.95);
            backdrop-filter: blur(5px);
            color: white;
            border-radius: 10px;
            padding: 15px;
            z-index: 100;
            border: 1px solid #eba576;
            width: 280px;
        }
        
        .action-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(44, 54, 67, 0.98);
            backdrop-filter: blur(10px);
            color: white;
            border-radius: 10px;
            padding: 20px;
            z-index: 200;
            border: 2px solid #eba576;
            width: 400px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .action-dialog select, .action-dialog input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            background: #1e262f;
            border: 1px solid #3d4855;
            color: white;
            border-radius: 3px;
        }
        
        .action-option {
            background: #1e262f;
            border: 1px solid #3d4855;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-option:hover {
            background: #2c3643;
            border-color: #eba576;
        }
        
        .action-option i {
            width: 24px;
            color: #eba576;
        }
    </style>
    
    <!-- Insert this line above script imports -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    
    <!-- Three.js -->
    <script src="resources/panotemplate/js/three.min.js"></script>
    <script src="resources/panotemplate/js/OrbitControls.js"></script>
    <script src="resources/panotemplate/js/jquery.js"></script>
    
    <!-- Insert this line after script imports -->
    <script>if (window.module) module = window.module;</script>
    
    <!-- Electron -->
    <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const fse = require('fs-extra');
        const path = require('path');
    </script>
</head>
<body>
    <div id="container"></div>
    
    <!-- Toolbar -->
    <div id="toolbar">
        <button class="tool-btn" id="select-mode" title="Select Object (Q)">
            <i class="fa fa-mouse-pointer"></i> Select
        </button>
        <button class="tool-btn" id="move-mode" title="Move (W)">
            <i class="fa fa-arrows"></i> Move
        </button>
        <button class="tool-btn" id="rotate-mode" title="Rotate (E)">
            <i class="fa fa-repeat"></i> Rotate
        </button>
        <button class="tool-btn" id="scale-mode" title="Scale (R)">
            <i class="fa fa-expand"></i> Scale
        </button>
        <div style="width: 1px; height: 30px; background: #eba576; margin: 0 10px;"></div>
        <button class="tool-btn" id="add-cube">
            <i class="fa fa-cube"></i> Cube
        </button>
        <button class="tool-btn" id="add-sphere">
            <i class="fa fa-circle"></i> Sphere
        </button>
        <button class="tool-btn" id="add-plane">
            <i class="fa fa-square"></i> Plane
        </button>
        <div style="width: 1px; height: 30px; background: #eba576; margin: 0 10px;"></div>
        <button class="tool-btn" id="save-scene">
            <i class="fa fa-floppy-o"></i> Save
        </button>
        <button class="tool-btn" id="close-editor">
            <i class="fa fa-times"></i> Close
        </button>
    </div>
    
    <!-- Object Properties Panel -->
    <div id="object-panel">
        <h3>Object Properties</h3>
        
        <div class="object-list" id="object-list">
            <!-- Object list will be populated here -->
        </div>
        
        <div id="selected-object-props">
            <div class="property-group">
                <label>Name</label>
                <input type="text" id="obj-name" placeholder="Object name">
                
                <label>Type</label>
                <select id="obj-type">
                    <option value="cube">Cube</option>
                    <option value="sphere">Sphere</option>
                    <option value="plane">Plane</option>
                </select>
                
                <label>Color</label>
                <input type="color" id="obj-color" value="#00ff00">
            </div>
            
            <div class="property-group">
                <label>Position</label>
                <div class="transform-controls">
                    <input type="number" id="obj-pos-x" step="0.1" placeholder="X">
                    <input type="number" id="obj-pos-y" step="0.1" placeholder="Y">
                    <input type="number" id="obj-pos-z" step="0.1" placeholder="Z">
                </div>
                
                <label>Rotation (degrees)</label>
                <div class="transform-controls">
                    <input type="number" id="obj-rot-x" step="1" placeholder="X">
                    <input type="number" id="obj-rot-y" step="1" placeholder="Y">
                    <input type="number" id="obj-rot-z" step="1" placeholder="Z">
                </div>
                
                <label>Scale</label>
                <div class="transform-controls">
                    <input type="number" id="obj-scale-x" step="0.1" min="0.1" value="1" placeholder="X">
                    <input type="number" id="obj-scale-y" step="0.1" min="0.1" value="1" placeholder="Y">
                    <input type="number" id="obj-scale-z" step="0.1" min="0.1" value="1" placeholder="Z">
                </div>
            </div>
            
            <!-- Actions Panel for 3D Objects -->
            <div class="actions-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #eba576;">Object Actions</h4>
                    <button class="btn btn-green" id="add-action" style="padding: 4px 10px; font-size: 11px;">
                        <i class="fa fa-plus"></i> Add Action
                    </button>
                </div>
                <div id="object-actions-list">
                    <!-- Actions will be listed here -->
                    <div style="color: #888; font-style: italic; text-align: center; padding: 10px;">
                        No actions. Click "Add Action" to create one.
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-green" id="apply-props" style="flex: 1;">Apply</button>
                <button class="btn btn-red" id="delete-object" style="flex: 1;">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Gizmo Mode -->
    <div class="gizmo">
        <div class="gizmo-btn" id="gizmo-local" title="Local Space">
            <i class="fa fa-cube"></i>
        </div>
        <div class="gizmo-btn" id="gizmo-world" title="World Space">
            <i class="fa fa-globe"></i>
        </div>
        <div class="gizmo-btn" id="gizmo-snap" title="Snap (hold Ctrl)">
            <i class="fa fa-magnet"></i>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div id="status-bar">
        <span id="status-text">Ready</span> | 
        <span id="object-count">0 objects</span>
    </div>
    
    <!-- Action Dialog (hidden by default) -->
    <div id="action-dialog" class="action-dialog" style="display: none;">
        <h3 style="margin-top: 0; color: #eba576;">Add Action to Object</h3>
        <p style="font-size: 12px; margin-bottom: 15px;">Select action type:</p>
        
        <div class="action-option" onclick="selectActionType(0)">
            <i class="fa fa-image"></i> <strong>Open Panorama</strong><br>
            <small>Switch to a different panorama scene</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(1)">
            <i class="fa fa-picture-o"></i> <strong>Show Image</strong><br>
            <small>Display an image overlay</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(2)">
            <i class="fa fa-film"></i> <strong>Play Video</strong><br>
            <small>Play a video file</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(3)">
            <i class="fa fa-music"></i> <strong>Play Audio</strong><br>
            <small>Play an audio file</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(4)">
            <i class="fa fa-file-pdf-o"></i> <strong>Open PDF</strong><br>
            <small>Open a PDF document</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(6)">
            <i class="fa fa-link"></i> <strong>Open URL</strong><br>
            <small>Open a website URL</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(7)">
            <i class="fa fa-code"></i> <strong>Execute JavaScript</strong><br>
            <small>Run custom JavaScript code</small>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn" onclick="closeActionDialog()">
                <i class="fa fa-times"></i> Cancel
            </button>
        </div>
    </div>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="resources/panotemplate/css/font-awesome.css">
    
    <script>
        // Scene variables
        let scene, camera, renderer, controls;
        let objects = [];
        let selectedObject = null;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        
        // Transform controls (simplified)
        let currentMode = 'select'; // select, move, rotate, scale
        let isDragging = false;
        let dragStart = new THREE.Vector2();
        
        // Scene data
        let sceneData;
        let sceneIndex;
        let projectDir;
        let tempDataFile;
        
        // Action dialog
        let pendingActionType = null;
        
        // Initialize
        function init() {
            // Load scene data
            loadSceneData();
            
            // Setup Three.js
            const container = document.getElementById('container');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111122);
            
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(5, 3, 8);
            camera.lookAt(0, 1, 0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = true;
            controls.maxPolarAngle = Math.PI / 2;
            
            // Lighting
            addLights();
            
            // Add grid and axes helper
            const gridHelper = new THREE.GridHelper(50, 50, 0xeba576, 0x3d4855);
            scene.add(gridHelper);
            
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            
            // Load existing objects
            loadObjectsFromScene();
            
            // Event listeners
            setupEventListeners();
            
            // Start animation
            animate();
        }
        
        function addLights() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x404060);
            scene.add(ambientLight);
            
            // Hemisphere light
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
            scene.add(hemiLight);
            
            // Directional light (sun)
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            dirLight.receiveShadow = true;
            dirLight.shadow.mapSize.width = 1024;
            dirLight.shadow.mapSize.height = 1024;
            const d = 15;
            dirLight.shadow.camera.left = -d;
            dirLight.shadow.camera.right = d;
            dirLight.shadow.camera.top = d;
            dirLight.shadow.camera.bottom = -d;
            dirLight.shadow.camera.near = 1;
            dirLight.shadow.camera.far = 25;
            scene.add(dirLight);
            
            // Fill light
            const fillLight = new THREE.PointLight(0x4466ff, 0.3);
            fillLight.position.set(-5, 3, 5);
            scene.add(fillLight);
        }
        
        function loadSceneData() {
            // Find the temp data file
            const args = process.argv;
            const tempDir = __dirname + '/temp/';
            
            if (!fs.existsSync(tempDir)) {
                fse.ensureDirSync(tempDir);
            }
            
            const files = fs.readdirSync(tempDir);
            const sceneFiles = files.filter(f => f.startsWith('scenedata_') && f.endsWith('.json'));
            
            if (sceneFiles.length > 0) {
                // Use the most recent one
                sceneFiles.sort();
                const latestFile = sceneFiles[sceneFiles.length - 1];
                tempDataFile = tempDir + latestFile;
                
                try {
                    const data = fs.readFileSync(tempDataFile, 'utf8');
                    sceneData = JSON.parse(data);
                    sceneIndex = sceneData.index;
                    projectDir = sceneData.projectDir;
                    
                    console.log("Loaded scene:", sceneData.scene.name);
                } catch(e) {
                    console.error("Error loading scene data:", e);
                }
            } else {
                // Create default scene data
                sceneData = {
                    index: 0,
                    projectDir: '',
                    scene: {
                        id: 'new_scene_' + Date.now(),
                        name: 'New Scene',
                        cameraPos: { x: 0, y: 1.6, z: 5 },
                        objects: []
                    }
                };
            }
        }
        
        function loadObjectsFromScene() {
            if (sceneData.scene.objects && sceneData.scene.objects.length > 0) {
                sceneData.scene.objects.forEach(objData => {
                    addObjectToScene(objData, false);
                });
            } else {
                // Add default objects if none exist
                addDefaultObjects();
            }
            
            updateObjectList();
        }
        
        function addDefaultObjects() {
            // Add a floor plane
            const floorData = {
                type: 'plane',
                width: 20,
                height: 20,
                color: 0x3d4855,
                posX: 0,
                posY: 0,
                posZ: 0,
                rotX: -90,
                rotY: 0,
                rotZ: 0,
                name: 'Floor',
                actions: []
            };
            addObjectToScene(floorData, true);
            
            // Add a cube
            const cubeData = {
                type: 'cube',
                width: 1,
                height: 1,
                depth: 1,
                color: 0xeba576,
                posX: 0,
                posY: 0.5,
                posZ: 0,
                rotX: 0,
                rotY: 0,
                rotZ: 0,
                scaleX: 1,
                scaleY: 1,
                scaleZ: 1,
                name: 'Cube',
                actions: []
            };
            addObjectToScene(cubeData, true);
        }
        
        function addObjectToScene(objData, addToData = true) {
            let geometry, material, mesh;
            
            switch(objData.type) {
                case 'cube':
                    geometry = new THREE.BoxGeometry(objData.width || 1, objData.height || 1, objData.depth || 1);
                    material = new THREE.MeshStandardMaterial({ color: objData.color || 0xeba576 });
                    mesh = new THREE.Mesh(geometry, material);
                    break;
                    
                case 'sphere':
                    geometry = new THREE.SphereGeometry(objData.radius || 0.7, 32, 32);
                    material = new THREE.MeshStandardMaterial({ color: objData.color || 0xeba576 });
                    mesh = new THREE.Mesh(geometry, material);
                    break;
                    
                case 'plane':
                    geometry = new THREE.PlaneGeometry(objData.width || 20, objData.height || 20);
                    material = new THREE.MeshStandardMaterial({ color: objData.color || 0x3d4855, side: THREE.DoubleSide });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.receiveShadow = true;
                    break;
                    
                default:
                    return null;
            }
            
            if (mesh) {
                mesh.position.set(objData.posX || 0, objData.posY || 0, objData.posZ || 0);
                
                mesh.rotation.set(
                    (objData.rotX || 0) * Math.PI / 180,
                    (objData.rotY || 0) * Math.PI / 180,
                    (objData.rotZ || 0) * Math.PI / 180
                );
                
                mesh.scale.set(objData.scaleX || 1, objData.scaleY || 1, objData.scaleZ || 1);
                
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                
                // Add unique ID if not exists
                if (!objData.id) {
                    objData.id = 'obj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                
                mesh.userData = {
                    id: objData.id,
                    type: objData.type,
                    originalData: { ...objData },
                    name: objData.name || `${objData.type}_${objects.length}`,
                    actions: objData.actions || []
                };
                
                scene.add(mesh);
                objects.push(mesh);
                
                if (addToData) {
                    if (!sceneData.scene.objects) sceneData.scene.objects = [];
                    sceneData.scene.objects.push(objData);
                }
            }
            
            return mesh;
        }
        
        function setupEventListeners() {
            // Window resize
            window.addEventListener('resize', onWindowResize);
            
            // Mouse events for object selection and dragging
            renderer.domElement.addEventListener('mousedown', onMouseDown);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('mouseup', onMouseUp);
            
            // Keyboard shortcuts
            window.addEventListener('keydown', onKeyDown);
            
            // Toolbar buttons
            document.getElementById('select-mode').addEventListener('click', () => setMode('select'));
            document.getElementById('move-mode').addEventListener('click', () => setMode('move'));
            document.getElementById('rotate-mode').addEventListener('click', () => setMode('rotate'));
            document.getElementById('scale-mode').addEventListener('click', () => setMode('scale'));
            
            document.getElementById('add-cube').addEventListener('click', () => addNewObject('cube'));
            document.getElementById('add-sphere').addEventListener('click', () => addNewObject('sphere'));
            document.getElementById('add-plane').addEventListener('click', () => addNewObject('plane'));
            
            document.getElementById('save-scene').addEventListener('click', saveScene);
            document.getElementById('close-editor').addEventListener('click', closeEditor);
            
            document.getElementById('apply-props').addEventListener('click', applyObjectProperties);
            document.getElementById('delete-object').addEventListener('click', deleteSelectedObject);
            document.getElementById('add-action').addEventListener('click', showActionDialog);
            
            // Property inputs
            document.getElementById('obj-name').addEventListener('input', updateObjectProperty);
            document.getElementById('obj-type').addEventListener('change', changeObjectType);
            document.getElementById('obj-color').addEventListener('input', updateObjectProperty);
            
            ['pos-x', 'pos-y', 'pos-z', 'rot-x', 'rot-y', 'rot-z', 'scale-x', 'scale-y', 'scale-z'].forEach(id => {
                document.getElementById(`obj-${id}`).addEventListener('input', updateObjectProperty);
            });
        }
        
        function setMode(mode) {
            currentMode = mode;
            
            // Update UI
            ['select', 'move', 'rotate', 'scale'].forEach(m => {
                const btn = document.getElementById(`${m}-mode`);
                if (m === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            updateStatus(`Mode: ${mode}`);
        }
        
        function addNewObject(type) {
            const newObj = {
                type: type,
                color: type === 'plane' ? 0x3d4855 : 0xeba576,
                posX: 0,
                posY: type === 'plane' ? 0 : 1,
                posZ: 0,
                rotX: 0,
                rotY: 0,
                rotZ: 0,
                scaleX: 1,
                scaleY: 1,
                scaleZ: 1,
                name: `${type}_${objects.length + 1}`,
                actions: []
            };
            
            if (type === 'cube') {
                newObj.width = 1;
                newObj.height = 1;
                newObj.depth = 1;
            } else if (type === 'sphere') {
                newObj.radius = 0.7;
            } else if (type === 'plane') {
                newObj.width = 20;
                newObj.height = 20;
                newObj.rotX = -90; // Default floor rotation
            }
            
            const mesh = addObjectToScene(newObj, true);
            selectObject(mesh);
            updateObjectList();
            updateStatus(`Added new ${type}`);
        }
        
        function onMouseDown(event) {
            if (event.button !== 0) return; // Left click only
            
            mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            // Check for object selection
            const intersects = raycaster.intersectObjects(objects);
            
            if (intersects.length > 0) {
                // Select the clicked object
                selectObject(intersects[0].object);
                
                if (currentMode === 'move' || currentMode === 'rotate' || currentMode === 'scale') {
                    // Start dragging
                    isDragging = true;
                    dragStart.set(mouse.x, mouse.y);
                }
            } else if (currentMode === 'select') {
                // Click on empty space - deselect
                selectObject(null);
            }
        }
        
        function onMouseMove(event) {
            if (!isDragging || !selectedObject) return;
            
            mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
            
            const deltaX = (mouse.x - dragStart.x) * 5;
            const deltaY = (mouse.y - dragStart.y) * 5;
            
            switch(currentMode) {
                case 'move':
                    // Move in camera plane
                    const moveVec = new THREE.Vector3(deltaX, -deltaY, 0);
                    moveVec.applyQuaternion(camera.quaternion);
                    moveVec.y = 0; // Keep on ground plane
                    selectedObject.position.add(moveVec.multiplyScalar(0.1));
                    break;
                    
                case 'rotate':
                    selectedObject.rotation.y += deltaX * 0.01;
                    selectedObject.rotation.x += deltaY * 0.01;
                    break;
                    
                case 'scale':
                    const scale = 1 + deltaX * 0.01;
                    selectedObject.scale.set(scale, scale, scale);
                    break;
            }
            
            updatePropertyInputs();
        }
        
        function onMouseUp() {
            if (isDragging && selectedObject) {
                // Update object data
                updateObjectDataFromMesh(selectedObject);
                isDragging = false;
            }
        }
        
        function selectObject(obj) {
            // Clear previous selection highlight
            objects.forEach(o => {
                if (o.material) {
                    if (Array.isArray(o.material)) {
                        o.material.forEach(m => m.emissive.setHex(0x000000));
                    } else {
                        o.material.emissive.setHex(0x000000);
                    }
                }
            });
            
            selectedObject = obj;
            
            if (obj) {
                // Highlight selected object
                if (obj.material) {
                    if (Array.isArray(obj.material)) {
                        obj.material.forEach(m => m.emissive.setHex(0x333333));
                    } else {
                        obj.material.emissive.setHex(0x333333);
                    }
                }
                
                updatePropertyInputs();
                updateActionsList();
                updateStatus(`Selected: ${obj.userData.name || 'Object'}`);
            } else {
                document.getElementById('obj-name').value = '';
                document.getElementById('object-actions-list').innerHTML = 
                    '<div style="color: #888; font-style: italic; text-align: center; padding: 10px;">No actions. Click "Add Action" to create one.</div>';
                updateStatus('No object selected');
            }
            
            updateObjectList();
        }
        
        function updatePropertyInputs() {
            if (!selectedObject) return;
            
            document.getElementById('obj-name').value = selectedObject.userData.name || '';
            document.getElementById('obj-type').value = selectedObject.userData.type || 'cube';
            
            // Color
            if (selectedObject.material && selectedObject.material.color) {
                const color = selectedObject.material.color;
                const hex = color.getHexString();
                document.getElementById('obj-color').value = '#' + hex;
            }
            
            // Position
            document.getElementById('obj-pos-x').value = selectedObject.position.x.toFixed(2);
            document.getElementById('obj-pos-y').value = selectedObject.position.y.toFixed(2);
            document.getElementById('obj-pos-z').value = selectedObject.position.z.toFixed(2);
            
            // Rotation (convert to degrees)
            document.getElementById('obj-rot-x').value = (selectedObject.rotation.x * 180 / Math.PI).toFixed(0);
            document.getElementById('obj-rot-y').value = (selectedObject.rotation.y * 180 / Math.PI).toFixed(0);
            document.getElementById('obj-rot-z').value = (selectedObject.rotation.z * 180 / Math.PI).toFixed(0);
            
            // Scale
            document.getElementById('obj-scale-x').value = selectedObject.scale.x.toFixed(2);
            document.getElementById('obj-scale-y').value = selectedObject.scale.y.toFixed(2);
            document.getElementById('obj-scale-z').value = selectedObject.scale.z.toFixed(2);
        }
        
        function updateActionsList() {
            if (!selectedObject) return;
            
            const actions = selectedObject.userData.actions || [];
            const container = document.getElementById('object-actions-list');
            
            if (actions.length === 0) {
                container.innerHTML = '<div style="color: #888; font-style: italic; text-align: center; padding: 10px;">No actions. Click "Add Action" to create one.</div>';
                return;
            }
            
            let html = '';
            actions.forEach((action, index) => {
                let actionTypeText = '';
                switch(action.type) {
                    case 0: actionTypeText = 'Open Panorama'; break;
                    case 1: actionTypeText = 'Show Image'; break;
                    case 2: actionTypeText = 'Play Video'; break;
                    case 3: actionTypeText = 'Play Audio'; break;
                    case 4: actionTypeText = 'Open PDF'; break;
                    case 5: actionTypeText = 'Open 3D Scene'; break;
                    case 6: actionTypeText = 'Open URL'; break;
                    case 7: actionTypeText = 'Execute JavaScript'; break;
                    default: actionTypeText = 'Unknown Action';
                }
                
                let targetText = action.target || action.url || 'No target';
                if (targetText.length > 30) targetText = targetText.substring(0, 30) + '...';
                
                html += `
                    <div class="action-item">
                        <div class="action-type">${actionTypeText}</div>
                        <div class="action-target">${targetText}</div>
                        <div class="action-remove" onclick="removeAction(${index})">
                            <i class="fa fa-trash"></i> Remove
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function removeAction(index) {
            if (!selectedObject) return;
            
            selectedObject.userData.actions.splice(index, 1);
            updateActionsList();
            updateObjectDataFromMesh(selectedObject);
            updateStatus('Action removed');
        }
        
        function updateObjectProperty() {
            if (!selectedObject) return;
            
            // Update name
            selectedObject.userData.name = document.getElementById('obj-name').value;
            
            // Update color
            const colorHex = document.getElementById('obj-color').value;
            if (selectedObject.material) {
                selectedObject.material.color.set(colorHex);
            }
            
            // Update position
            selectedObject.position.x = parseFloat(document.getElementById('obj-pos-x').value) || 0;
            selectedObject.position.y = parseFloat(document.getElementById('obj-pos-y').value) || 0;
            selectedObject.position.z = parseFloat(document.getElementById('obj-pos-z').value) || 0;
            
            // Update rotation
            selectedObject.rotation.x = (parseFloat(document.getElementById('obj-rot-x').value) || 0) * Math.PI / 180;
            selectedObject.rotation.y = (parseFloat(document.getElementById('obj-rot-y').value) || 0) * Math.PI / 180;
            selectedObject.rotation.z = (parseFloat(document.getElementById('obj-rot-z').value) || 0) * Math.PI / 180;
            
            // Update scale
            selectedObject.scale.x = parseFloat(document.getElementById('obj-scale-x').value) || 1;
            selectedObject.scale.y = parseFloat(document.getElementById('obj-scale-y').value) || 1;
            selectedObject.scale.z = parseFloat(document.getElementById('obj-scale-z').value) || 1;
            
            updateObjectDataFromMesh(selectedObject);
        }
        
        function updateObjectDataFromMesh(mesh) {
            if (sceneData.scene.objects) {
                // Find by ID
                const dataObj = sceneData.scene.objects.find(obj => 
                    obj.id === mesh.userData.id
                );
                
                if (dataObj) {
                    dataObj.posX = mesh.position.x;
                    dataObj.posY = mesh.position.y;
                    dataObj.posZ = mesh.position.z;
                    
                    dataObj.rotX = mesh.rotation.x * 180 / Math.PI;
                    dataObj.rotY = mesh.rotation.y * 180 / Math.PI;
                    dataObj.rotZ = mesh.rotation.z * 180 / Math.PI;
                    
                    dataObj.scaleX = mesh.scale.x;
                    dataObj.scaleY = mesh.scale.y;
                    dataObj.scaleZ = mesh.scale.z;
                    
                    dataObj.color = mesh.material.color.getHex();
                    dataObj.name = mesh.userData.name;
                    dataObj.actions = mesh.userData.actions || [];
                    
                    mesh.userData.originalData = { ...dataObj };
                }
            }
        }
        
        function changeObjectType() {
            if (!selectedObject) return;
            
            const newType = document.getElementById('obj-type').value;
            const oldData = selectedObject.userData.originalData;
            const actions = selectedObject.userData.actions || [];
            
            // Create new object data
            const newData = {
                type: newType,
                color: parseInt(document.getElementById('obj-color').value.substring(1), 16),
                posX: selectedObject.position.x,
                posY: selectedObject.position.y,
                posZ: selectedObject.position.z,
                rotX: selectedObject.rotation.x * 180 / Math.PI,
                rotY: selectedObject.rotation.y * 180 / Math.PI,
                rotZ: selectedObject.rotation.z * 180 / Math.PI,
                scaleX: selectedObject.scale.x,
                scaleY: selectedObject.scale.y,
                scaleZ: selectedObject.scale.z,
                name: selectedObject.userData.name,
                actions: actions
            };
            
            if (newType === 'cube') {
                newData.width = oldData.width || 1;
                newData.height = oldData.height || 1;
                newData.depth = oldData.depth || 1;
            } else if (newType === 'sphere') {
                newData.radius = oldData.radius || 0.7;
            } else if (newType === 'plane') {
                newData.width = oldData.width || 20;
                newData.height = oldData.height || 20;
            }
            
            // Remove old object from scene
            scene.remove(selectedObject);
            objects = objects.filter(obj => obj !== selectedObject);
            
            // Remove from data
            if (sceneData.scene.objects) {
                sceneData.scene.objects = sceneData.scene.objects.filter(obj => 
                    obj.id !== selectedObject.userData.id
                );
            }
            
            // Add new object
            const newMesh = addObjectToScene(newData, true);
            selectObject(newMesh);
            updateObjectList();
        }
        
        function deleteSelectedObject() {
            if (!selectedObject) return;
            
            if (confirm('Delete selected object?')) {
                // Remove from scene
                scene.remove(selectedObject);
                objects = objects.filter(obj => obj !== selectedObject);
                
                // Remove from data
                if (sceneData.scene.objects) {
                    sceneData.scene.objects = sceneData.scene.objects.filter(obj => 
                        obj.id !== selectedObject.userData.id
                    );
                }
                
                selectObject(null);
                updateObjectList();
                updateStatus('Object deleted');
            }
        }
        
        function updateObjectList() {
            const list = document.getElementById('object-list');
            list.innerHTML = '<h4 style="margin: 0 0 10px 0;">Objects</h4>';
            
            objects.forEach((obj) => {
                const div = document.createElement('div');
                div.className = 'object-item' + (obj === selectedObject ? ' selected' : '');
                
                let icon = 'cube';
                if (obj.userData.type === 'sphere') icon = 'circle';
                else if (obj.userData.type === 'plane') icon = 'square';
                
                div.innerHTML = `
                    <div class="object-icon"><i class="fa fa-${icon}"></i></div>
                    <div class="object-info">
                        <div class="object-name">${obj.userData.name || obj.userData.type}</div>
                        <div class="object-type">${obj.userData.type}</div>
                    </div>
                `;
                div.onclick = () => selectObject(obj);
                list.appendChild(div);
            });
            
            document.getElementById('object-count').innerText = objects.length + ' objects';
        }
        
        function applyObjectProperties() {
            updateObjectProperty();
            updateStatus('Properties applied');
        }
        
        // Action Dialog Functions
        function showActionDialog() {
            if (!selectedObject) {
                alert('Please select an object first');
                return;
            }
            document.getElementById('action-dialog').style.display = 'block';
        }
        
        function closeActionDialog() {
            document.getElementById('action-dialog').style.display = 'none';
            pendingActionType = null;
        }
        
        function selectActionType(type) {
            pendingActionType = type;
            
            switch(type) {
                case 0: // Open Panorama
                    showPanoramaChooser();
                    break;
                case 1: // Show Image
                    showAssetChooser('images', 'Choose Image');
                    break;
                case 2: // Play Video
                    showAssetChooser('videos', 'Choose Video');
                    break;
                case 3: // Play Audio
                    showAssetChooser('audios', 'Choose Audio');
                    break;
                case 4: // Open PDF
                    showAssetChooser('pdf', 'Choose PDF');
                    break;
                case 6: // Open URL
                    showURLInput();
                    break;
                case 7: // Execute JavaScript
                    showJSInput();
                    break;
                default:
                    alert('Action type not implemented yet');
                    closeActionDialog();
            }
        }
        
        function showPanoramaChooser() {
            // Close the action dialog first
            closeActionDialog();
            
            // Use the main app's item chooser via IPC
            const dialogHTML = `
                <div class="action-dialog" style="display: block;">
                    <h3 style="margin-top: 0;">Choose Panorama</h3>
                    <p>Enter panorama filename:</p>
                    <input type="text" id="panorama-name" placeholder="panorama.jpg" style="width: 100%; padding: 8px; margin: 10px 0;">
                    <div style="text-align: right;">
                        <button class="btn" onclick="document.getElementById('custom-dialog').remove()">Cancel</button>
                        <button class="btn btn-green" onclick="addPanoramaAction()">Add Action</button>
                    </div>
                </div>
            `;
            
            const dialogDiv = document.createElement('div');
            dialogDiv.id = 'custom-dialog';
            dialogDiv.innerHTML = dialogHTML;
            document.body.appendChild(dialogDiv);
            
            // Focus the input
            setTimeout(() => document.getElementById('panorama-name').focus(), 100);
        }
        
        function addPanoramaAction() {
            const panoName = document.getElementById('panorama-name').value.trim();
            if (panoName) {
                addActionToSelectedObject(0, panoName);
            }
            document.getElementById('custom-dialog').remove();
        }
        
        function showAssetChooser(assetType, title) {
            // Close the action dialog first
            closeActionDialog();
            
            // Create a simple dialog with input for asset name
            const dialogHTML = `
                <div class="action-dialog" style="display: block;">
                    <h3 style="margin-top: 0;">${title}</h3>
                    <p>Enter ${assetType} filename:</p>
                    <input type="text" id="asset-name" placeholder="filename.${assetType === 'images' ? 'jpg' : assetType === 'videos' ? 'mp4' : assetType === 'audios' ? 'mp3' : 'pdf'}" style="width: 100%; padding: 8px; margin: 10px 0;">
                    <div style="text-align: right;">
                        <button class="btn" onclick="document.getElementById('custom-dialog').remove()">Cancel</button>
                        <button class="btn btn-green" onclick="addAssetAction('${assetType}')">Add Action</button>
                    </div>
                </div>
            `;
            
            const dialogDiv = document.createElement('div');
            dialogDiv.id = 'custom-dialog';
            dialogDiv.innerHTML = dialogHTML;
            document.body.appendChild(dialogDiv);
            
            // Focus the input
            setTimeout(() => document.getElementById('asset-name').focus(), 100);
        }
        
        function addAssetAction(assetType) {
            const assetName = document.getElementById('asset-name').value.trim();
            if (assetName) {
                let targetPath = `${assetType}/${assetName}`;
                if (assetType === 'images') addActionToSelectedObject(1, targetPath);
                else if (assetType === 'videos') addActionToSelectedObject(2, targetPath);
                else if (assetType === 'audios') addActionToSelectedObject(3, targetPath);
                else if (assetType === 'pdf') addActionToSelectedObject(4, targetPath);
            }
            document.getElementById('custom-dialog').remove();
        }
        
        function showURLInput() {
            closeActionDialog();
            
            const dialogHTML = `
                <div class="action-dialog" style="display: block;">
                    <h3 style="margin-top: 0;">Open URL</h3>
                    <p>Enter URL:</p>
                    <input type="text" id="url-input" placeholder="https://example.com" style="width: 100%; padding: 8px; margin: 10px 0;">
                    <div style="text-align: right;">
                        <button class="btn" onclick="document.getElementById('custom-dialog').remove()">Cancel</button>
                        <button class="btn btn-green" onclick="addURLAction()">Add Action</button>
                    </div>
                </div>
            `;
            
            const dialogDiv = document.createElement('div');
            dialogDiv.id = 'custom-dialog';
            dialogDiv.innerHTML = dialogHTML;
            document.body.appendChild(dialogDiv);
            
            setTimeout(() => document.getElementById('url-input').focus(), 100);
        }
        
        function addURLAction() {
            const url = document.getElementById('url-input').value.trim();
            if (url) {
                addActionToSelectedObject(6, url);
            }
            document.getElementById('custom-dialog').remove();
        }
        
        function showJSInput() {
            closeActionDialog();
            
            const dialogHTML = `
                <div class="action-dialog" style="display: block;">
                    <h3 style="margin-top: 0;">JavaScript Code</h3>
                    <p>Enter JavaScript code:</p>
                    <textarea id="js-input" rows="5" style="width: 100%; padding: 8px; margin: 10px 0; background: #1e262f; color: white; border: 1px solid #3d4855;"></textarea>
                    <div style="text-align: right;">
                        <button class="btn" onclick="document.getElementById('custom-dialog').remove()">Cancel</button>
                        <button class="btn btn-green" onclick="addJSAction()">Add Action</button>
                    </div>
                </div>
            `;
            
            const dialogDiv = document.createElement('div');
            dialogDiv.id = 'custom-dialog';
            dialogDiv.innerHTML = dialogHTML;
            document.body.appendChild(dialogDiv);
            
            setTimeout(() => document.getElementById('js-input').focus(), 100);
        }
        
        function addJSAction() {
            const jsCode = document.getElementById('js-input').value.trim();
            if (jsCode) {
                addActionToSelectedObject(7, jsCode);
            }
            document.getElementById('custom-dialog').remove();
        }
        
        function addActionToSelectedObject(type, target) {
            if (!selectedObject) return;
            
            if (!selectedObject.userData.actions) {
                selectedObject.userData.actions = [];
            }
            
            selectedObject.userData.actions.push({
                type: type,
                target: target
            });
            
            updateActionsList();
            updateObjectDataFromMesh(selectedObject);
            updateStatus('Action added');
        }
        
        function onKeyDown(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key.toLowerCase()) {
                    case 's':
                        event.preventDefault();
                        saveScene();
                        break;
                    case 'w':
                        event.preventDefault();
                        closeEditor();
                        break;
                }
                return;
            }
            
            // Mode shortcuts
            switch(event.key) {
                case 'q': setMode('select'); break;
                case 'w': setMode('move'); break;
                case 'e': setMode('rotate'); break;
                case 'r': setMode('scale'); break;
                case 'Delete':
                    if (selectedObject) deleteSelectedObject();
                    break;
            }
            
            // Snap modifier
            if (event.key === 'Control') {
                document.getElementById('gizmo-snap').classList.add('active');
            }
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            controls.update();
            renderer.render(scene, camera);
        }
        
        function saveScene() {
            // Update camera position
            sceneData.scene.cameraPos = {
                x: camera.position.x,
                y: camera.position.y,
                z: camera.position.z
            };
            
            // Save to temp file
            fs.writeFileSync(tempDataFile, JSON.stringify(sceneData));
            
            updateStatus('Scene saved!');
            
            // Flash effect
            document.body.style.backgroundColor = '#0d9e59';
            setTimeout(() => {
                document.body.style.backgroundColor = '';
            }, 200);
        }
        
        function closeEditor() {
            // Auto-save before closing
            saveScene();
            
            // Close window
            const { remote } = require('electron');
            const win = remote.getCurrentWindow();
            win.close();
        }
        
        function updateStatus(text) {
            document.getElementById('status-text').innerText = text;
        }
        
        // Start everything
        window.onload = init;
    </script>
</body>
</html>