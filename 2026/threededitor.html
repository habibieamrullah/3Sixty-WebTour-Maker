<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>3D Scene Visual Editor</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Quicksand', sans-serif;
            background-color: #3d4855;
            color: #cccccc;
        }
		
		#custom-dialog {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(0,0,0,0.7);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}
        
        #container {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        
        #toolbar {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c3643;
            color: white;
            padding: 8px 15px;
            display: flex;
            gap: 10px;
            z-index: 100;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border: 1px solid #eba576;
        }
        
        .tool-btn {
            background-color: #2c3643;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color .5s, color .5s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tool-btn:hover {
            background-color: #eba576;
            color: #3d4855;
        }
        
        .tool-btn.active {
            background-color: #0d9e59;
            color: white;
        }
        
        #object-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            width: 340px;
            background-color: #2c3643;
            color: white;
            padding: 15px;
            z-index: 100;
            border: 1px solid #eba576;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        #object-panel h3 {
            margin: 0 0 15px 0;
            color: #eba576;
            border-bottom: 1px solid #eba576;
            padding-bottom: 8px;
            font-weight: normal;
        }
        
        .object-list {
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .object-item {
            background-color: #3d4855;
            margin-bottom: 5px;
            padding: 8px;
            cursor: pointer;
            transition: background-color .5s, color .5s, border .5s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .object-item:hover {
            background-color: #505a6c;
            color: #eba576;
        }
        
        .object-item.selected {
            border-color: #eba576;
            background-color: #505a6c;
        }
        
        .object-item .object-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #2c3643;
        }
        
        .object-item .object-info {
            flex: 1;
        }
        
        .object-item .object-name {
            font-weight: bold;
            font-size: 13px;
        }
        
        .object-item .object-type {
            font-size: 10px;
            color: #eba576;
        }
        
        .property-group {
            margin-bottom: 15px;
            background-color: #232c37;
            padding: 12px;
            border-left: 3px solid #eba576;
        }
        
        .property-group label {
            display: block;
            font-size: 12px;
            color: #eba576;
            margin-bottom: 5px;
        }
        
        .property-group input, .property-group select {
            width: 100%;
            padding: 5px;
            border: 1px solid gray;
            background-color: #2c3643;
            color: #eba576;
            margin-bottom: 8px;
            font-size: 13px;
            transition: background-color .5s;
        }
        
        .property-group input:hover, .property-group select:hover {
            background-color: #505a6c;
        }
        
        .property-group input:focus {
            background-color: #505a6c;
        }
        
        .property-group input[type="color"] {
            height: 35px;
            padding: 2px;
        }
        
        .transform-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }
        
        .transform-controls input {
            text-align: center;
        }
        
        .btn {
            background-color: #2c3643;
            color: white;
            border: 1px solid #eba576;
            padding: 5px 15px;
            cursor: pointer;
            transition: background-color .5s, color .5s;
            font-size: 13px;
            font-weight: bold;
            min-width: 60px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .btn:hover {
            background-color: #eba576;
            color: #3d4855;
        }
        
        .btn-green {
            background-color: #0d9e59;
            border-color: #0d9e59;
            color: white;
        }
        
        .btn-green:hover {
            background-color: #00e075;
            color: white;
        }
        
        .btn-red {
            background-color: #cf0000;
            border-color: #cf0000;
            color: white;
        }
        
        .btn-red:hover {
            background-color: #ff0000;
            color: white;
        }
        
        .btn-blue {
            background-color: #0066cc;
            border-color: #0066cc;
            color: white;
        }
        
        .btn-blue:hover {
            background-color: #0077ff;
            color: white;
        }
        
        .btn-small {
            padding: 3px 10px;
            font-size: 11px;
        }
        
        #status-bar {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: #eba576;
            padding: 5px 10px;
            font-size: 12px;
            z-index: 100;
        }
        
        .gizmo {
            position: fixed;
            bottom: 40px;
            left: 10px;
            background-color: #2c3643;
            color: white;
            padding: 8px;
            display: flex;
            gap: 5px;
            z-index: 100;
            border: 1px solid #eba576;
        }
        
        .gizmo-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #2c3643;
            border: 1px solid #eba576;
            cursor: pointer;
            transition: background-color .5s, color .5s;
        }
        
        .gizmo-btn:hover, .gizmo-btn.active {
            background-color: #eba576;
            color: #3d4855;
        }
        
        .actions-panel {
            margin-top: 15px;
            border-top: 1px solid #eba576;
            padding-top: 15px;
        }
        
        .action-item {
            background-color: #1e262f;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 12px;
            border: 1px solid #2c3643;
        }
        
        .action-type {
            color: #eba576;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .action-target {
            background-color: #2c3643;
            padding: 5px;
            word-break: break-all;
        }
        
        .action-remove {
            color: #cf0000;
            cursor: pointer;
            margin-top: 5px;
            text-align: right;
            font-size: 11px;
        }
        
        .action-remove:hover {
            text-decoration: underline;
        }
        
        .hotspot-creator {
            position: fixed;
            top: 70px;
            left: 10px;
            background-color: #2c3643;
            color: white;
            padding: 15px;
            z-index: 100;
            border: 1px solid #eba576;
            width: 280px;
        }
        
        .action-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #232c37;
            color: white;
            padding: 20px;
            z-index: 200;
            border: 2px solid #eba576;
            width: 400px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        }
        
        .action-dialog select, .action-dialog input {
            width: 100%;
            padding: 5px;
            margin: 10px 0;
            background-color: #2c3643;
            border: 1px solid gray;
            color: #eba576;
            transition: background-color .5s;
        }
        
        .action-dialog select:hover, .action-dialog input:hover {
            background-color: #505a6c;
        }
        
        .action-option {
            background-color: #1e262f;
            border: 1px solid #2c3643;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color .5s, color .5s, border .5s;
        }
        
        .action-option:hover {
            background-color: #505a6c;
            border-color: #eba576;
            color: #eba576;
        }
        
        .action-option i {
            width: 24px;
            color: #eba576;
        }
        
        .texture-preview {
            width: 100%;
            height: 80px;
            background-color: #1e262f;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #eba576;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .texture-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .skybox-preview {
            width: 100%;
            height: 60px;
            background-color: #1e262f;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #eba576;
            display: flex;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
        }

        /* Scrollbar styling sesuai standard */
        ::-webkit-scrollbar {
            width: 0.5em;
            height: 0.5em;
        }
        
        ::-webkit-scrollbar-track {
            background: #2c3643; 
        }
        
        ::-webkit-scrollbar-thumb {
            background: #0d9e59; 
            transition: background .5s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #00e075; 
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eba576;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px;
            background-color: #2c3643;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color .5s;
        }
        
        .tab-btn.active {
            background-color: #eba576;
            color: #3d4855;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
    </style>
    
    <!-- Insert this line above script imports -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    
    <!-- Three.js -->
    <script src="resources/panotemplate/js/three.min.js"></script>
	<script src="resources/panotemplate/js/TransformControls.js"></script>
    <script src="resources/panotemplate/js/OrbitControls.js"></script>
    <script src="resources/panotemplate/js/jquery.js"></script>
	
    
    <!-- Insert this line after script imports -->
    <script>if (window.module) module = window.module;</script>
    
    <!-- Electron -->
    <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const fse = require('fs-extra');
        const path = require('path');
        const { dialog } = require('electron').remote;
    </script>
</head>
<body>
    <div id="container"></div>
    
    <!-- Toolbar -->
    <div id="toolbar">
        <button class="tool-btn active" id="move-mode" title="Move Object (Q)">
            <i class="fa fa-arrows"></i> Move
        </button>
        <button class="tool-btn" id="rotate-mode" title="Rotate (W)">
            <i class="fa fa-repeat"></i> Rotate
        </button>
        <button class="tool-btn" id="scale-mode" title="Scale (E)">
            <i class="fa fa-expand"></i> Scale
        </button>
        <div style="width: 1px; height: 30px; background: #eba576; margin: 0 10px;"></div>
        <button class="tool-btn" id="add-cube">
            <i class="fa fa-cube"></i> Cube
        </button>
        <button class="tool-btn" id="add-sphere">
            <i class="fa fa-circle"></i> Sphere
        </button>
        <button class="tool-btn" id="add-plane">
            <i class="fa fa-square"></i> Plane
        </button>
        <div style="width: 1px; height: 30px; background: #eba576; margin: 0 10px;"></div>
        <button class="tool-btn" id="save-scene">
            <i class="fa fa-floppy-o"></i> Save
        </button>
        <button class="tool-btn" id="close-editor">
            <i class="fa fa-times"></i> Close
        </button>
    </div>
    
    <!-- Tab buttons for switching between Object and Environment -->
    <div style="position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 100;">
        <div class="tab-buttons" style="background-color: #2c3643; border: 1px solid #eba576;">
            <button class="tab-btn active" id="tab-objects"><i class="fa fa-cube"></i> Objects</button>
            <button class="tab-btn" id="tab-environment"><i class="fa fa-globe"></i> Environment</button>
        </div>
    </div>
    
    <!-- Object Properties Panel -->
    <div id="object-panel" style="top: 120px;">
        <!-- Objects Tab -->
        <div id="objects-tab" class="tab-panel active">
            <h3>Object Properties</h3>
            
            <div class="object-list" id="object-list">
                <!-- Object list will be populated here -->
            </div>
            
            <div id="selected-object-props">
                <div class="property-group">
                    <label>Name</label>
                    <input type="text" id="obj-name" placeholder="Object name">
                    
                    <label>Type</label>
                    <select id="obj-type">
                        <option value="cube">Cube</option>
                        <option value="sphere">Sphere</option>
                        <option value="plane">Plane</option>
                    </select>
                    
                    <label>Material Type</label>
                    <select id="obj-material-type">
                        <option value="color">Solid Color</option>
                        <option value="texture">Texture Image</option>
                    </select>
                    
                    <div id="color-control">
                        <label>Color</label>
                        <input type="color" id="obj-color" value="#00ff00">
                    </div>
                    
                    <div id="texture-control" style="display: none;">
                        <label>Texture Image</label>
                        <div class="texture-preview" id="texture-preview">
                            <i class="fa fa-image" style="font-size: 30px; color: #eba576;"></i>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="obj-texture" readonly placeholder="No texture selected" style="flex: 1;">
                            <button class="btn btn-small" id="browse-texture"><i class="fa fa-folder"></i></button>
                            <button class="btn btn-small" id="clear-texture"><i class="fa fa-times"></i></button>
                        </div>
                        <small style="color: #888;">Supports PNG with transparency</small>
                    </div>
                </div>
                
                <div class="property-group">
                    <label>Position</label>
                    <div class="transform-controls">
                        <input type="number" id="obj-pos-x" step="0.1" placeholder="X">
                        <input type="number" id="obj-pos-y" step="0.1" placeholder="Y">
                        <input type="number" id="obj-pos-z" step="0.1" placeholder="Z">
                    </div>
                    
                    <label>Rotation (degrees)</label>
                    <div class="transform-controls">
                        <input type="number" id="obj-rot-x" step="1" placeholder="X">
                        <input type="number" id="obj-rot-y" step="1" placeholder="Y">
                        <input type="number" id="obj-rot-z" step="1" placeholder="Z">
                    </div>
                    
                    <label>Scale</label>
                    <div class="transform-controls">
                        <input type="number" id="obj-scale-x" step="0.1" min="0.1" value="1" placeholder="X">
                        <input type="number" id="obj-scale-y" step="0.1" min="0.1" value="1" placeholder="Y">
                        <input type="number" id="obj-scale-z" step="0.1" min="0.1" value="1" placeholder="Z">
                    </div>
                </div>
                
                <!-- Actions Panel for 3D Objects -->
                <div class="actions-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #eba576;">Object Actions</h4>
                        <button class="btn btn-green" id="add-action" style="padding: 4px 10px; font-size: 11px;">
                            <i class="fa fa-plus"></i> Add Action
                        </button>
                    </div>
                    <div id="object-actions-list">
                        <!-- Actions will be listed here -->
                        <div style="color: #888; font-style: italic; text-align: center; padding: 10px;">
                            No actions. Click "Add Action" to create one.
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-green" id="apply-props" style="flex: 1;">Apply</button>
                    <button class="btn btn-red" id="delete-object" style="flex: 1;">Delete</button>
                </div>
            </div>
        </div>
        
        <!-- Environment Tab -->
        <div id="environment-tab" class="tab-panel">
            <h3>Environment Settings</h3>
            
            <div class="property-group">
                <label>Skybox Type</label>
                <select id="skybox-type">
                    <option value="none">No Skybox (Dark)</option>
                    <option value="color">Solid Color</option>
                    <option value="panorama">360 Panorama (Equirectangular)</option>
                </select>
            </div>
            
            <div id="skybox-color-control" class="property-group" style="display: none;">
                <label>Background Color</label>
                <input type="color" id="skybox-color" value="#111122">
            </div>
            
            <div id="skybox-panorama-control" class="property-group" style="display: none;">
                <label>Panorama Image</label>
                <div class="skybox-preview" id="skybox-preview" style="background-image: none;">
                    <i class="fa fa-image" style="font-size: 24px; color: #eba576;"></i>
                </div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="skybox-panorama" readonly placeholder="No panorama selected" style="flex: 1;">
                    <button class="btn btn-small" id="browse-skybox"><i class="fa fa-folder"></i></button>
                    <button class="btn btn-small" id="clear-skybox"><i class="fa fa-times"></i></button>
                </div>
                <small style="color: #888;">Select a 360° equirectangular panorama from your panoramas folder</small>
            </div>
            
            <div class="property-group">
                <label>Lighting</label>
                <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                    <label style="flex: 1; font-size: 11px; color: #ccc;">
                        <input type="checkbox" id="env-ambient" checked> Ambient Light
                    </label>
                    <label style="flex: 1; font-size: 11px; color: #ccc;">
                        <input type="checkbox" id="env-hemisphere" checked> Hemisphere Light
                    </label>
                </div>
                <div style="display: flex; gap: 5px;">
                    <label style="flex: 1; font-size: 11px; color: #ccc;">
                        <input type="checkbox" id="env-directional" checked> Directional Light
                    </label>
                </div>
            </div>
            
            <div class="property-group">
                <label>Grid & Helpers</label>
                <div style="display: flex; gap: 5px;">
                    <label style="flex: 1; font-size: 11px; color: #ccc;">
                        <input type="checkbox" id="env-grid" checked> Show Grid
                    </label>
                    <label style="flex: 1; font-size: 11px; color: #ccc;">
                        <input type="checkbox" id="env-axes" checked> Show Axes
                    </label>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-green" id="apply-environment" style="flex: 1;">Apply Environment</button>
                <button class="btn" id="reset-environment" style="flex: 1;">Reset</button>
            </div>
        </div>
    </div>
    
    <!-- Gizmo Mode -->
    <div class="gizmo">
        <div class="gizmo-btn" id="gizmo-local" title="Local Space">
            <i class="fa fa-cube"></i>
        </div>
        <div class="gizmo-btn" id="gizmo-world" title="World Space">
            <i class="fa fa-globe"></i>
        </div>
        <div class="gizmo-btn" id="gizmo-snap" title="Snap (hold Ctrl)">
            <i class="fa fa-magnet"></i>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div id="status-bar">
        <span id="status-text">Ready</span> | 
        <span id="object-count">0 objects</span>
    </div>
    
    <!-- Action Dialog (hidden by default) -->
    <div id="action-dialog" class="action-dialog" style="display: none;">
        <h3 style="margin-top: 0; color: #eba576;">Add Action to Object</h3>
        <p style="font-size: 12px; margin-bottom: 15px;">Select action type:</p>
        
        <div class="action-option" onclick="selectActionType(0)">
            <i class="fa fa-image"></i> <strong>Open Panorama</strong><br>
            <small>Switch to a different panorama scene</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(1)">
            <i class="fa fa-picture-o"></i> <strong>Show Image</strong><br>
            <small>Display an image overlay</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(2)">
            <i class="fa fa-film"></i> <strong>Play Video</strong><br>
            <small>Play a video file</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(3)">
            <i class="fa fa-music"></i> <strong>Play Audio</strong><br>
            <small>Play an audio file</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(4)">
            <i class="fa fa-file-pdf-o"></i> <strong>Open PDF</strong><br>
            <small>Open a PDF document</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(6)">
            <i class="fa fa-link"></i> <strong>Open URL</strong><br>
            <small>Open a website URL</small>
        </div>
        
        <div class="action-option" onclick="selectActionType(7)">
            <i class="fa fa-code"></i> <strong>Execute JavaScript</strong><br>
            <small>Run custom JavaScript code</small>
        </div>
        
        <div style="text-align: right; margin-top: 20px;">
            <button class="btn" onclick="closeActionDialog()">
                <i class="fa fa-times"></i> Cancel
            </button>
        </div>
    </div>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="resources/panotemplate/css/font-awesome.css">
    
    <script>
        // Scene variables
        let scene, camera, renderer, controls;
        let objects = [];
        let selectedObject = null;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        
        // Transform controls
        let currentMode = 'move';
        let transformControls;
        let isTransforming = false;
        
        // Scene data
        let sceneData;
        let sceneIndex;
        let projectDir;
        let tempDataFile;
        
        // Environment variables
        let skyboxMesh = null;
        let gridHelper = null;
        let axesHelper = null;
        
        // Action dialog
        let pendingActionType = null;
        let tempSourceFile = null; // Untuk menyimpan file yang dipilih
        
        // Initialize
        function init() {
            // Load scene data
            loadSceneData();
            
            // Setup Three.js
            const container = document.getElementById('container');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111122);
            
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(5, 3, 8);
            camera.lookAt(0, 1, 0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            controls = new THREE.OrbitControls(camera, renderer.domElement);
			controls.enableDamping = true;
			
			// Transform Controls
			try {
				transformControls = new THREE.TransformControls(camera, renderer.domElement);
				transformControls.addEventListener('dragging-changed', function (event) {
					controls.enabled = !event.value;
					isTransforming = event.value;
					
					if (!event.value && selectedObject) {
						updateObjectDataFromMesh(selectedObject);
						updatePropertyInputs();
					}
				});
				
				transformControls.setSize(0.8);
				transformControls.setMode('translate');
				scene.add(transformControls);
				
				console.log("TransformControls OK!");
			} catch(e) {
				console.error("TransformControls error:", e);
			}
			
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = true;
            controls.maxPolarAngle = Math.PI / 2;
            
            // Lighting
            addLights();
            
            // Add grid and axes helper
            gridHelper = new THREE.GridHelper(50, 50, 0xeba576, 0x3d4855);
            scene.add(gridHelper);
            
            axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            
            // Load existing objects
            loadObjectsFromScene();
            
            // Load environment settings
            loadEnvironmentSettings();
            
            // Event listeners
            setupEventListeners();
            
            // Start animation
            animate();
        }
        
        function addLights() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x404060);
            ambientLight.name = "ambientLight";
            scene.add(ambientLight);
            
            // Hemisphere light
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
            hemiLight.name = "hemisphereLight";
            scene.add(hemiLight);
            
            // Directional light (sun)
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            dirLight.receiveShadow = true;
            dirLight.shadow.mapSize.width = 1024;
            dirLight.shadow.mapSize.height = 1024;
            const d = 15;
            dirLight.shadow.camera.left = -d;
            dirLight.shadow.camera.right = d;
            dirLight.shadow.camera.top = d;
            dirLight.shadow.camera.bottom = -d;
            dirLight.shadow.camera.near = 1;
            dirLight.shadow.camera.far = 25;
            dirLight.name = "directionalLight";
            scene.add(dirLight);
            
            // Fill light
            const fillLight = new THREE.PointLight(0x4466ff, 0.3);
            fillLight.position.set(-5, 3, 5);
            fillLight.name = "fillLight";
            scene.add(fillLight);
        }
        
        function loadSceneData() {
            // Find the temp data file
            const args = process.argv;
            const tempDir = __dirname + '/temp/';
            
            if (!fs.existsSync(tempDir)) {
                fse.ensureDirSync(tempDir);
            }
            
            const files = fs.readdirSync(tempDir);
            const sceneFiles = files.filter(f => f.startsWith('scenedata_') && f.endsWith('.json'));
            
            if (sceneFiles.length > 0) {
                // Use the most recent one
                sceneFiles.sort();
                const latestFile = sceneFiles[sceneFiles.length - 1];
                tempDataFile = tempDir + latestFile;
                
                try {
                    const data = fs.readFileSync(tempDataFile, 'utf8');
                    sceneData = JSON.parse(data);
                    sceneIndex = sceneData.index;
                    projectDir = sceneData.projectDir;
                    
                    // Initialize environment if not exists
                    if (!sceneData.scene.environment) {
                        sceneData.scene.environment = {
                            skyboxType: 'none',
                            skyboxColor: '#111122',
                            skyboxPanorama: null,
                            lights: {
                                ambient: true,
                                hemisphere: true,
                                directional: true
                            },
                            showGrid: true,
                            showAxes: true
                        };
                    }
                    
                    console.log("Loaded scene:", sceneData.scene.name);
                } catch(e) {
                    console.error("Error loading scene data:", e);
                }
            } else {
                // Create default scene data
                sceneData = {
                    index: 0,
                    projectDir: '',
                    scene: {
                        id: 'new_scene_' + Date.now(),
                        name: 'New Scene',
                        cameraPos: { x: 0, y: 1.6, z: 5 },
                        objects: [],
                        environment: {
                            skyboxType: 'none',
                            skyboxColor: '#111122',
                            skyboxPanorama: null,
                            lights: {
                                ambient: true,
                                hemisphere: true,
                                directional: true
                            },
                            showGrid: true,
                            showAxes: true
                        }
                    }
                };
            }
        }
        
        function loadEnvironmentSettings() {
            const env = sceneData.scene.environment;
            
            // Set UI controls
            document.getElementById('skybox-type').value = env.skyboxType || 'none';
            document.getElementById('skybox-color').value = env.skyboxColor || '#111122';
            document.getElementById('skybox-panorama').value = env.skyboxPanorama || '';
            
            document.getElementById('env-ambient').checked = env.lights?.ambient !== false;
            document.getElementById('env-hemisphere').checked = env.lights?.hemisphere !== false;
            document.getElementById('env-directional').checked = env.lights?.directional !== false;
            
            document.getElementById('env-grid').checked = env.showGrid !== false;
            document.getElementById('env-axes').checked = env.showAxes !== false;
            
            // Apply environment
            applyEnvironmentSettings();
        }
        
        function applyEnvironmentSettings() {
            const env = sceneData.scene.environment;
            
            // Update skybox
            updateSkybox();
            
            // Update lights
            updateLights();
            
            // Update helpers
            if (gridHelper) gridHelper.visible = env.showGrid !== false;
            if (axesHelper) axesHelper.visible = env.showAxes !== false;
            
            // Update UI visibility
            document.getElementById('skybox-color-control').style.display = env.skyboxType === 'color' ? 'block' : 'none';
            document.getElementById('skybox-panorama-control').style.display = env.skyboxType === 'panorama' ? 'block' : 'none';
            
            // Update preview
            if (env.skyboxType === 'panorama' && env.skyboxPanorama) {
                const preview = document.getElementById('skybox-preview');
                const panoramaPath = projectDir + '/panoramas/' + env.skyboxPanorama;
                if (fs.existsSync(panoramaPath)) {
                    preview.style.backgroundImage = `url('file://${panoramaPath}')`;
                    preview.innerHTML = '';
                }
            } else {
                document.getElementById('skybox-preview').style.backgroundImage = 'none';
                document.getElementById('skybox-preview').innerHTML = '<i class="fa fa-image" style="font-size: 24px; color: #eba576;"></i>';
            }
        }
		
		function debugSkybox() {
			console.log("=== SKYBOX DEBUG INFO ===");
			console.log("Scene background type:", scene.background ? 
				(scene.background.isColor ? "Color" : "Texture") : "None");
			
			if (scene.background && scene.background.isTexture) {
				console.log("Texture mapping:", scene.background.mapping);
				console.log("Texture image:", scene.background.image ? 
					scene.background.image.src : "No image");
			}
			
			console.log("Skybox mesh exists:", !!skyboxMesh);
			if (skyboxMesh) {
				console.log("⚠️ Warning: Skybox mesh should not exist when using scene.background!");
			}
			
			console.log("Camera position:", camera.position);
			console.log("Scene name:", sceneData?.scene?.name || "Unknown");
		}

		// Panggil setelah updateSkybox
		setTimeout(debugSkybox, 2000);
		
		
		function switchTo3DScene(sceneId) {
			console.log("Switching to 3D scene:", sceneId);
			
			const sceneData = threeDScenes[sceneId];
			
			if (!sceneData) {
				console.error("3D Scene not found:", sceneId);
				return;
			}
			
			mode = "3d";
			current3DSceneId = sceneId;
			
			// Hapus panorama sphere dari scene
			if (panoramaMesh && scene.children.includes(panoramaMesh)) {
				scene.remove(panoramaMesh);
			}
			
			// Hapus semua hotspot
			clearHotspots();
			
			// Hapus semua 3D objects yang ada
			clear3DScene();

			// Reset background ke null dulu
			scene.background = null;
			
			// Reset lights
			const lightsToRemove = [];
			scene.children.forEach(obj => {
				if (obj.isLight) lightsToRemove.push(obj);
			});
			lightsToRemove.forEach(light => scene.remove(light));
			
			// Buat ulang lights
			ambientLight = new THREE.AmbientLight(0x404060);
			scene.add(ambientLight);
			
			hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
			scene.add(hemisphereLight);
			
			directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
			directionalLight.position.set(5, 10, 7);
			directionalLight.castShadow = true;
			directionalLight.receiveShadow = true;
			scene.add(directionalLight);
			
			const backLight = new THREE.PointLight(0x4466ff, 0.5);
			backLight.position.set(-5, 3, -5);
			scene.add(backLight);
			
			// Set environment settings
			if (sceneData.environment) {
				// === METODE YANG BENAR: Gunakan Scene.background dengan Texture ===
				if (sceneData.environment.skyboxType === 'panorama' && sceneData.environment.skyboxPanorama) {
					const panoramaPath = 'panoramas/' + sceneData.environment.skyboxPanorama;
					
					// Load texture dan set sebagai background
					const textureLoader = new THREE.TextureLoader();
					textureLoader.load(panoramaPath, (texture) => {
						// Untuk panorama equirectangular, kita perlu set mapping
						texture.mapping = THREE.EquirectangularRefractionMapping;
						
						// Set sebagai scene background - INI YANG PALING BENAR!
						scene.background = texture;
						
						// Important: Set environment map untuk refleksi (optional)
						scene.environment = texture;
						
						console.log("✅ Skybox set as scene background:", panoramaPath);
					});
					
				} else if (sceneData.environment.skyboxType === 'color' && sceneData.environment.skyboxColor) {
					scene.background = new THREE.Color(sceneData.environment.skyboxColor);
				} else {
					scene.background = new THREE.Color(0x111122);
				}
				
				// Grid and axes
				if (gridHelper) scene.remove(gridHelper);
				if (axesHelper) scene.remove(axesHelper);
				
				if (sceneData.environment.showGrid !== false) {
					gridHelper = new THREE.GridHelper(50, 50, 0xeba576, 0x3d4855);
					scene.add(gridHelper);
				}
				
				if (sceneData.environment.showAxes !== false) {
					axesHelper = new THREE.AxesHelper(5);
					scene.add(axesHelper);
				}
				
			} else {
				scene.background = new THREE.Color(0x111122);
			}
			
			// Set camera position
			if (sceneData.cameraPos) {
				camera.position.set(
					sceneData.cameraPos.x, 
					sceneData.cameraPos.y, 
					sceneData.cameraPos.z
				);
				controls.target.set(0, 1, 0);
			} else {
				camera.position.set(5, 3, 8);
				controls.target.set(0, 1, 0);
			}
			
			// Set controls untuk 3D mode
			controls.enablePan = true;
			controls.maxDistance = 200;
			controls.minDistance = 1;
			
			// Add objects from scene data
			if (sceneData.objects && sceneData.objects.length > 0) {
				sceneData.objects.forEach(objData => {
					const mesh = addObjectToScene(objData);
					if (mesh) {
						scene.add(mesh);
						threeDSceneObjects.push(mesh);
					}
				});
			}
			
			// Update UI
			controlsInfo.style.display = 'block';
			overlay.style.opacity = '0';
			overlay.style.pointerEvents = 'none';
			
			console.log("3D scene ready");
		}
        
        function updateSkybox() {
			const env = sceneData.scene.environment;
			
			// Remove old skybox
			if (skyboxMesh) {
				scene.remove(skyboxMesh);
				skyboxMesh = null;
			}
			
			// Reset background
			scene.background = null;
			
			switch(env.skyboxType) {
				case 'color':
					scene.background = new THREE.Color(env.skyboxColor || '#111122');
					break;
					
				case 'panorama':
					if (env.skyboxPanorama) {
						const panoramaPath = projectDir + '/panoramas/' + env.skyboxPanorama;
						if (fs.existsSync(panoramaPath)) {
							try {
								// === METODE YANG BENAR: Gunakan Scene.background dengan EquirectangularMapping ===
								const textureLoader = new THREE.TextureLoader();
								const texture = textureLoader.load('file://' + panoramaPath);
								
								// Set mapping untuk equirectangular panorama
								texture.mapping = THREE.EquirectangularRefractionMapping;
								
								// Set sebagai scene background - INI YANG PALING BENAR!
								scene.background = texture;
								
								// Optional: Set sebagai environment map untuk refleksi
								scene.environment = texture;
								
								console.log("✅ Skybox set as scene background using EquirectangularMapping");
								
							} catch(e) {
								console.error("Error loading skybox panorama:", e);
								scene.background = new THREE.Color(0x111122);
							}
						} else {
							console.error("Panorama file not found:", panoramaPath);
							scene.background = new THREE.Color(0x111122);
						}
					} else {
						scene.background = new THREE.Color(0x111122);
					}
					break;
					
				default:
					scene.background = new THREE.Color(0x111122);
					break;
			}
		}
		
		function reset3DScene() {
			// Hapus semua 3D objects
			threeDSceneObjects.forEach(obj => scene.remove(obj));
			threeDSceneObjects = [];
			
			// Hapus skybox mesh
			if (skyboxMesh) {
				scene.remove(skyboxMesh);
				skyboxMesh = null;
			}
			
			// Reset lights (akan dibuat ulang)
			scene.children.forEach(obj => {
				if (obj.isLight) scene.remove(obj);
			});
		}
        
        function updateLights() {
			const env = sceneData.scene.environment;
			
			// Traverse scene dengan aman
			scene.children.forEach(obj => {
				if (obj.name === 'ambientLight') obj.visible = env.lights?.ambient !== false;
				if (obj.name === 'hemisphereLight') obj.visible = env.lights?.hemisphere !== false;
				if (obj.name === 'directionalLight') obj.visible = env.lights?.directional !== false;
				if (obj.name === 'fillLight') obj.visible = env.lights?.directional !== false;
			});
		}
        
        function loadObjectsFromScene() {
            if (sceneData.scene.objects && sceneData.scene.objects.length > 0) {
                sceneData.scene.objects.forEach(objData => {
                    addObjectToScene(objData, false);
                });
            } else {
                // Add default objects if none exist
                addDefaultObjects();
            }
            
            updateObjectList();
        }
        
        function addDefaultObjects() {
            // Add a floor plane
            const floorData = {
                type: 'plane',
                width: 20,
                height: 20,
                color: 0x3d4855,
                posX: 0,
                posY: 0,
                posZ: 0,
                rotX: -90,
                rotY: 0,
                rotZ: 0,
                name: 'Floor',
                actions: [],
                materialType: 'color'
            };
            addObjectToScene(floorData, true);
            
            // Add a cube
            const cubeData = {
                type: 'cube',
                width: 1,
                height: 1,
                depth: 1,
                color: 0xeba576,
                posX: 0,
                posY: 0.5,
                posZ: 0,
                rotX: 0,
                rotY: 0,
                rotZ: 0,
                scaleX: 1,
                scaleY: 1,
                scaleZ: 1,
                name: 'Cube',
                actions: [],
                materialType: 'color'
            };
            addObjectToScene(cubeData, true);
        }
        
        function addObjectToScene(objData, addToData = true) {
			let geometry, material, mesh;
			
			// Determine material type
			const materialType = objData.materialType || 'color';
			const color = objData.color || 0xeba576;
			
			// Create material based on type
			if (materialType === 'texture' && objData.texture) {
				const texturePath = projectDir + '/images/' + objData.texture;
				if (fs.existsSync(texturePath)) {
					const texture = new THREE.TextureLoader().load('file://' + texturePath);
					
					// Check if it's PNG with transparency
					if (objData.texture.toLowerCase().endsWith('.png')) {
						material = new THREE.MeshStandardMaterial({ 
							map: texture,
							transparent: true
							// Hapus side: THREE.DoubleSide untuk non-plane
						});
					} else {
						material = new THREE.MeshStandardMaterial({ 
							map: texture
							// Hapus side: THREE.DoubleSide untuk non-plane
						});
					}
				} else {
					material = new THREE.MeshStandardMaterial({ color: color });
				}
			} else {
				material = new THREE.MeshStandardMaterial({ color: color });
			}
			
			switch(objData.type) {
				case 'cube':
					geometry = new THREE.BoxGeometry(objData.width || 1, objData.height || 1, objData.depth || 1);
					mesh = new THREE.Mesh(geometry, material);
					break;
					
				case 'sphere':
					geometry = new THREE.SphereGeometry(objData.radius || 0.7, 32, 32);
					mesh = new THREE.Mesh(geometry, material);
					break;
					
				case 'plane':
					geometry = new THREE.PlaneGeometry(objData.width || 20, objData.height || 20);
					// Plane perlu DoubleSide agar terlihat dari kedua sisi
					material.side = THREE.DoubleSide;
					mesh = new THREE.Mesh(geometry, material);
					mesh.receiveShadow = true;
					break;
					
				default:
					return null;
			}
			
			if (mesh) {
				mesh.position.set(objData.posX || 0, objData.posY || 0, objData.posZ || 0);
				
				mesh.rotation.set(
					(objData.rotX || 0) * Math.PI / 180,
					(objData.rotY || 0) * Math.PI / 180,
					(objData.rotZ || 0) * Math.PI / 180
				);
				
				mesh.scale.set(objData.scaleX || 1, objData.scaleY || 1, objData.scaleZ || 1);
				
				mesh.castShadow = true;
				mesh.receiveShadow = true;
				
				// Add unique ID if not exists
				if (!objData.id) {
					objData.id = 'obj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
				}
				
				mesh.userData = {
					id: objData.id,
					type: objData.type,
					originalData: { ...objData },
					name: objData.name || `${objData.type}_${objects.length}`,
					actions: objData.actions || [],
					materialType: objData.materialType || 'color',
					texture: objData.texture || null
				};
				
				scene.add(mesh);
				objects.push(mesh);
				
				if (addToData) {
					if (!sceneData.scene.objects) sceneData.scene.objects = [];
					sceneData.scene.objects.push(objData);
				}
			}
			
			return mesh;
		}
        
        function setupEventListeners() {
			// Window resize
			window.addEventListener('resize', onWindowResize);
			
			// Mouse events
			renderer.domElement.addEventListener('mousedown', onMouseDown);
			
			// Keyboard shortcuts
			window.addEventListener('keydown', onKeyDown);
            
            // Toolbar buttons
            document.getElementById('move-mode').addEventListener('click', () => setMode('move'));
            document.getElementById('rotate-mode').addEventListener('click', () => setMode('rotate'));
            document.getElementById('scale-mode').addEventListener('click', () => setMode('scale'));
            
            document.getElementById('add-cube').addEventListener('click', () => addNewObject('cube'));
            document.getElementById('add-sphere').addEventListener('click', () => addNewObject('sphere'));
            document.getElementById('add-plane').addEventListener('click', () => addNewObject('plane'));
            
            document.getElementById('save-scene').addEventListener('click', saveScene);
            document.getElementById('close-editor').addEventListener('click', closeEditor);
            
            document.getElementById('apply-props').addEventListener('click', applyObjectProperties);
            document.getElementById('delete-object').addEventListener('click', deleteSelectedObject);
            document.getElementById('add-action').addEventListener('click', showActionDialog);
            
            // Tab switching
            document.getElementById('tab-objects').addEventListener('click', () => {
                document.getElementById('tab-objects').classList.add('active');
                document.getElementById('tab-environment').classList.remove('active');
                document.getElementById('objects-tab').classList.add('active');
                document.getElementById('environment-tab').classList.remove('active');
            });
            
            document.getElementById('tab-environment').addEventListener('click', () => {
                document.getElementById('tab-objects').classList.remove('active');
                document.getElementById('tab-environment').classList.add('active');
                document.getElementById('objects-tab').classList.remove('active');
                document.getElementById('environment-tab').classList.add('active');
            });
            
            // Material type toggle
            document.getElementById('obj-material-type').addEventListener('change', function() {
                const val = this.value;
                document.getElementById('color-control').style.display = val === 'color' ? 'block' : 'none';
                document.getElementById('texture-control').style.display = val === 'texture' ? 'block' : 'none';
                
                if (selectedObject) {
                    selectedObject.userData.materialType = val;
                    if (val === 'color') {
                        updateObjectMaterialColor();
                    }
                }
            });
            
            // Texture buttons
            document.getElementById('browse-texture').addEventListener('click', () => {
                showAssetChooser('images', 'Choose Texture Image', (filename) => {
                    document.getElementById('obj-texture').value = filename;
                    document.getElementById('texture-preview').innerHTML = `<img src="file://${projectDir}/images/${filename}" style="max-width: 100%; max-height: 100%;">`;
                    
                    if (selectedObject) {
                        selectedObject.userData.texture = filename;
                        updateObjectMaterialTexture(filename);
                    }
                });
            });
            
            document.getElementById('clear-texture').addEventListener('click', () => {
                document.getElementById('obj-texture').value = '';
                document.getElementById('texture-preview').innerHTML = '<i class="fa fa-image" style="font-size: 30px; color: #eba576;"></i>';
                
                if (selectedObject) {
                    selectedObject.userData.texture = null;
                    selectedObject.userData.materialType = 'color';
                    document.getElementById('obj-material-type').value = 'color';
                    document.getElementById('color-control').style.display = 'block';
                    document.getElementById('texture-control').style.display = 'none';
                    updateObjectMaterialColor();
                }
            });
            
            // Environment controls
            document.getElementById('skybox-type').addEventListener('change', function() {
                sceneData.scene.environment.skyboxType = this.value;
                applyEnvironmentSettings();
            });
            
            document.getElementById('skybox-color').addEventListener('input', function() {
                sceneData.scene.environment.skyboxColor = this.value;
                if (sceneData.scene.environment.skyboxType === 'color') {
                    applyEnvironmentSettings();
                }
            });
            
            document.getElementById('browse-skybox').addEventListener('click', () => {
                showAssetChooser('panoramas', 'Choose Skybox Panorama', (filename) => {
                    document.getElementById('skybox-panorama').value = filename;
                    sceneData.scene.environment.skyboxPanorama = filename;
                    applyEnvironmentSettings();
                });
            });
            
            document.getElementById('clear-skybox').addEventListener('click', () => {
                document.getElementById('skybox-panorama').value = '';
                sceneData.scene.environment.skyboxPanorama = null;
                applyEnvironmentSettings();
            });
            
            document.getElementById('apply-environment').addEventListener('click', () => {
                const env = sceneData.scene.environment;
                env.lights = {
                    ambient: document.getElementById('env-ambient').checked,
                    hemisphere: document.getElementById('env-hemisphere').checked,
                    directional: document.getElementById('env-directional').checked
                };
                env.showGrid = document.getElementById('env-grid').checked;
                env.showAxes = document.getElementById('env-axes').checked;
                
                applyEnvironmentSettings();
                updateStatus('Environment updated');
            });
            
            document.getElementById('reset-environment').addEventListener('click', () => {
                sceneData.scene.environment = {
                    skyboxType: 'none',
                    skyboxColor: '#111122',
                    skyboxPanorama: null,
                    lights: {
                        ambient: true,
                        hemisphere: true,
                        directional: true
                    },
                    showGrid: true,
                    showAxes: true
                };
                loadEnvironmentSettings();
            });
            
            // Property inputs
            document.getElementById('obj-name').addEventListener('input', updateObjectProperty);
            document.getElementById('obj-type').addEventListener('change', changeObjectType);
            document.getElementById('obj-color').addEventListener('input', updateObjectMaterialColor);
            
            ['pos-x', 'pos-y', 'pos-z', 'rot-x', 'rot-y', 'rot-z', 'scale-x', 'scale-y', 'scale-z'].forEach(id => {
                document.getElementById(`obj-${id}`).addEventListener('input', updateObjectProperty);
            });
        }
        
        function updateObjectMaterialColor() {
            if (!selectedObject) return;
            
            const colorHex = document.getElementById('obj-color').value;
            if (selectedObject.material) {
                if (Array.isArray(selectedObject.material)) {
                    selectedObject.material.forEach(m => m.color.set(colorHex));
                } else {
                    selectedObject.material.color.set(colorHex);
                }
            }
            
            updateObjectDataFromMesh(selectedObject);
        }
        
        function updateObjectMaterialTexture(filename) {
            if (!selectedObject) return;
            
            const texturePath = projectDir + '/images/' + filename;
            if (fs.existsSync(texturePath)) {
                const texture = new THREE.TextureLoader().load('file://' + texturePath);
                
                const isPNG = filename.toLowerCase().endsWith('.png');
                
                if (Array.isArray(selectedObject.material)) {
                    selectedObject.material.forEach(m => {
                        m.map = texture;
                        m.transparent = isPNG;
                        m.needsUpdate = true;
                    });
                } else {
                    selectedObject.material.map = texture;
                    selectedObject.material.transparent = isPNG;
                    selectedObject.material.needsUpdate = true;
                }
                
                updateObjectDataFromMesh(selectedObject);
            }
        }
        
        function setMode(mode) {
			currentMode = mode;
			
			// Update transform controls mode
			if (transformControls) {
				transformControls.setMode(mode === 'move' ? 'translate' : mode);
			}
			
			// Update UI
			['move', 'rotate', 'scale'].forEach(m => {
				const btn = document.getElementById(`${m}-mode`);
				if (m === mode) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
			});
			
			updateStatus(`Mode: ${mode}`);
		}
        
        function addNewObject(type) {
            const newObj = {
                type: type,
                color: type === 'plane' ? 0x3d4855 : 0xeba576,
                posX: 0,
                posY: type === 'plane' ? 0 : 1,
                posZ: 0,
                rotX: 0,
                rotY: 0,
                rotZ: 0,
                scaleX: 1,
                scaleY: 1,
                scaleZ: 1,
                name: `${type}_${objects.length + 1}`,
                actions: [],
                materialType: 'color'
            };
            
            if (type === 'cube') {
                newObj.width = 1;
                newObj.height = 1;
                newObj.depth = 1;
            } else if (type === 'sphere') {
                newObj.radius = 0.7;
            } else if (type === 'plane') {
                newObj.width = 20;
                newObj.height = 20;
                newObj.rotX = -90; // Default floor rotation
            }
            
            const mesh = addObjectToScene(newObj, true);
            selectObject(mesh);
            updateObjectList();
            updateStatus(`Added new ${type}`);
        }
        
        function onMouseDown(event) {
			if (event.button !== 0) return; // Left click only
			if (isTransforming) return; // Don't select while transforming
			
			mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
			mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
			
			raycaster.setFromCamera(mouse, camera);
			
			// Check for object selection
			const intersects = raycaster.intersectObjects(objects);
			
			if (intersects.length > 0) {
				// Select the clicked object
				selectObject(intersects[0].object);
			} else {
				// Click on empty space - deselect
				selectObject(null);
			}
		}
        
        function selectObject(obj) {
			// Detach dulu
			if (transformControls) {
				transformControls.detach();
			}
			
			// Clear highlight
			objects.forEach(o => {
				if (o.material) {
					if (Array.isArray(o.material)) {
						o.material.forEach(m => m.emissive?.setHex(0x000000));
					} else {
						o.material.emissive?.setHex(0x000000);
					}
				}
			});
			
			selectedObject = obj;
			
			if (obj && transformControls) {
				// ATTACH ke object yang dipilih
				transformControls.attach(obj);
				
				// Set mode sesuai tombol yang dipilih
				transformControls.setMode(currentMode === 'move' ? 'translate' : currentMode);
				
				// Highlight
				if (obj.material) {
					if (Array.isArray(obj.material)) {
						obj.material.forEach(m => m.emissive?.setHex(0x333333));
					} else {
						obj.material.emissive?.setHex(0x333333);
					}
				}
				
				updatePropertyInputs();
				updateActionsList();
				updateStatus(`Selected: ${obj.userData.name || 'Object'}`);
			} else {
				document.getElementById('obj-name').value = '';
				document.getElementById('object-actions-list').innerHTML = 
					'<div style="color: #888; font-style: italic; text-align: center; padding: 10px;">No actions.</div>';
				updateStatus('No object selected');
			}
			
			updateObjectList();
		}
        
        function updatePropertyInputs() {
            if (!selectedObject) return;
            
            document.getElementById('obj-name').value = selectedObject.userData.name || '';
            document.getElementById('obj-type').value = selectedObject.userData.type || 'cube';
            
            const materialType = selectedObject.userData.materialType || 'color';
            document.getElementById('obj-material-type').value = materialType;
            
            if (materialType === 'color') {
                document.getElementById('color-control').style.display = 'block';
                document.getElementById('texture-control').style.display = 'none';
            } else {
                document.getElementById('color-control').style.display = 'none';
                document.getElementById('texture-control').style.display = 'block';
                
                const textureFile = selectedObject.userData.texture || '';
                document.getElementById('obj-texture').value = textureFile;
                
                if (textureFile) {
                    const texturePath = projectDir + '/images/' + textureFile;
                    if (fs.existsSync(texturePath)) {
                        document.getElementById('texture-preview').innerHTML = `<img src="file://${texturePath}" style="max-width: 100%; max-height: 100%;">`;
                    }
                } else {
                    document.getElementById('texture-preview').innerHTML = '<i class="fa fa-image" style="font-size: 30px; color: #eba576;"></i>';
                }
            }
            
            // Color
            if (selectedObject.material && selectedObject.material.color) {
                const color = selectedObject.material.color;
                const hex = color.getHexString();
                document.getElementById('obj-color').value = '#' + hex;
            }
            
            // Position
            document.getElementById('obj-pos-x').value = selectedObject.position.x.toFixed(2);
            document.getElementById('obj-pos-y').value = selectedObject.position.y.toFixed(2);
            document.getElementById('obj-pos-z').value = selectedObject.position.z.toFixed(2);
            
            // Rotation (convert to degrees)
            document.getElementById('obj-rot-x').value = (selectedObject.rotation.x * 180 / Math.PI).toFixed(0);
            document.getElementById('obj-rot-y').value = (selectedObject.rotation.y * 180 / Math.PI).toFixed(0);
            document.getElementById('obj-rot-z').value = (selectedObject.rotation.z * 180 / Math.PI).toFixed(0);
            
            // Scale
            document.getElementById('obj-scale-x').value = selectedObject.scale.x.toFixed(2);
            document.getElementById('obj-scale-y').value = selectedObject.scale.y.toFixed(2);
            document.getElementById('obj-scale-z').value = selectedObject.scale.z.toFixed(2);
        }
        
        function updateActionsList() {
            if (!selectedObject) return;
            
            const actions = selectedObject.userData.actions || [];
            const container = document.getElementById('object-actions-list');
            
            if (actions.length === 0) {
                container.innerHTML = '<div style="color: #888; font-style: italic; text-align: center; padding: 10px;">No actions. Click "Add Action" to create one.</div>';
                return;
            }
            
            let html = '';
            actions.forEach((action, index) => {
                let actionTypeText = '';
                switch(action.type) {
                    case 0: actionTypeText = 'Open Panorama'; break;
                    case 1: actionTypeText = 'Show Image'; break;
                    case 2: actionTypeText = 'Play Video'; break;
                    case 3: actionTypeText = 'Play Audio'; break;
                    case 4: actionTypeText = 'Open PDF'; break;
                    case 5: actionTypeText = 'Open 3D Scene'; break;
                    case 6: actionTypeText = 'Open URL'; break;
                    case 7: actionTypeText = 'Execute JavaScript'; break;
                    default: actionTypeText = 'Unknown Action';
                }
                
                let targetText = action.target || action.url || 'No target';
                if (targetText.length > 30) targetText = targetText.substring(0, 30) + '...';
                
                html += `
                    <div class="action-item">
                        <div class="action-type">${actionTypeText}</div>
                        <div class="action-target">${targetText}</div>
                        <div class="action-remove" onclick="removeAction(${index})">
                            <i class="fa fa-trash"></i> Remove
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function removeAction(index) {
            if (!selectedObject) return;
            
            selectedObject.userData.actions.splice(index, 1);
            updateActionsList();
            updateObjectDataFromMesh(selectedObject);
            updateStatus('Action removed');
        }
        
        function updateObjectProperty() {
            if (!selectedObject) return;
            
            // Update name
            selectedObject.userData.name = document.getElementById('obj-name').value;
            
            // Update position
            selectedObject.position.x = parseFloat(document.getElementById('obj-pos-x').value) || 0;
            selectedObject.position.y = parseFloat(document.getElementById('obj-pos-y').value) || 0;
            selectedObject.position.z = parseFloat(document.getElementById('obj-pos-z').value) || 0;
            
            // Update rotation
            selectedObject.rotation.x = (parseFloat(document.getElementById('obj-rot-x').value) || 0) * Math.PI / 180;
            selectedObject.rotation.y = (parseFloat(document.getElementById('obj-rot-y').value) || 0) * Math.PI / 180;
            selectedObject.rotation.z = (parseFloat(document.getElementById('obj-rot-z').value) || 0) * Math.PI / 180;
            
            // Update scale
            selectedObject.scale.x = parseFloat(document.getElementById('obj-scale-x').value) || 1;
            selectedObject.scale.y = parseFloat(document.getElementById('obj-scale-y').value) || 1;
            selectedObject.scale.z = parseFloat(document.getElementById('obj-scale-z').value) || 1;
            
            updateObjectDataFromMesh(selectedObject);
        }
        
        function updateObjectDataFromMesh(mesh) {
            if (sceneData.scene.objects) {
                // Find by ID
                const dataObj = sceneData.scene.objects.find(obj => 
                    obj.id === mesh.userData.id
                );
                
                if (dataObj) {
                    dataObj.posX = mesh.position.x;
                    dataObj.posY = mesh.position.y;
                    dataObj.posZ = mesh.position.z;
                    
                    dataObj.rotX = mesh.rotation.x * 180 / Math.PI;
                    dataObj.rotY = mesh.rotation.y * 180 / Math.PI;
                    dataObj.rotZ = mesh.rotation.z * 180 / Math.PI;
                    
                    dataObj.scaleX = mesh.scale.x;
                    dataObj.scaleY = mesh.scale.y;
                    dataObj.scaleZ = mesh.scale.z;
                    
                    if (mesh.material && mesh.material.color) {
                        dataObj.color = mesh.material.color.getHex();
                    }
                    
                    dataObj.name = mesh.userData.name;
                    dataObj.actions = mesh.userData.actions || [];
                    dataObj.materialType = mesh.userData.materialType || 'color';
                    dataObj.texture = mesh.userData.texture || null;
                    
                    mesh.userData.originalData = { ...dataObj };
                }
            }
        }
        
        function changeObjectType() {
            if (!selectedObject) return;
            
            const newType = document.getElementById('obj-type').value;
            const oldData = selectedObject.userData.originalData;
            const actions = selectedObject.userData.actions || [];
            
            // Create new object data
            const newData = {
                type: newType,
                color: parseInt(document.getElementById('obj-color').value.substring(1), 16),
                posX: selectedObject.position.x,
                posY: selectedObject.position.y,
                posZ: selectedObject.position.z,
                rotX: selectedObject.rotation.x * 180 / Math.PI,
                rotY: selectedObject.rotation.y * 180 / Math.PI,
                rotZ: selectedObject.rotation.z * 180 / Math.PI,
                scaleX: selectedObject.scale.x,
                scaleY: selectedObject.scale.y,
                scaleZ: selectedObject.scale.z,
                name: selectedObject.userData.name,
                actions: actions,
                materialType: selectedObject.userData.materialType || 'color',
                texture: selectedObject.userData.texture || null
            };
            
            if (newType === 'cube') {
                newData.width = oldData.width || 1;
                newData.height = oldData.height || 1;
                newData.depth = oldData.depth || 1;
            } else if (newType === 'sphere') {
                newData.radius = oldData.radius || 0.7;
            } else if (newType === 'plane') {
                newData.width = oldData.width || 20;
                newData.height = oldData.height || 20;
            }
            
            // Remove old object from scene
            scene.remove(selectedObject);
            objects = objects.filter(obj => obj !== selectedObject);
            
            // Remove from data
            if (sceneData.scene.objects) {
                sceneData.scene.objects = sceneData.scene.objects.filter(obj => 
                    obj.id !== selectedObject.userData.id
                );
            }
            
            // Add new object
            const newMesh = addObjectToScene(newData, true);
            selectObject(newMesh);
            updateObjectList();
        }
        
        function deleteSelectedObject() {
            if (!selectedObject) return;
            
            if (confirm('Delete selected object?')) {
                // Remove from scene
                scene.remove(selectedObject);
                objects = objects.filter(obj => obj !== selectedObject);
                
                // Remove from data
                if (sceneData.scene.objects) {
                    sceneData.scene.objects = sceneData.scene.objects.filter(obj => 
                        obj.id !== selectedObject.userData.id
                    );
                }
                
                selectObject(null);
                updateObjectList();
                updateStatus('Object deleted');
            }
        }
        
        function updateObjectList() {
            const list = document.getElementById('object-list');
            list.innerHTML = '<h4 style="margin: 0 0 10px 0;">Objects</h4>';
            
            objects.forEach((obj) => {
                const div = document.createElement('div');
                div.className = 'object-item' + (obj === selectedObject ? ' selected' : '');
                
                let icon = 'cube';
                if (obj.userData.type === 'sphere') icon = 'circle';
                else if (obj.userData.type === 'plane') icon = 'square';
                
                div.innerHTML = `
                    <div class="object-icon"><i class="fa fa-${icon}"></i></div>
                    <div class="object-info">
                        <div class="object-name">${obj.userData.name || obj.userData.type}</div>
                        <div class="object-type">${obj.userData.type}</div>
                    </div>
                `;
                div.onclick = () => selectObject(obj);
                list.appendChild(div);
            });
            
            document.getElementById('object-count').innerText = objects.length + ' objects';
        }
        
        function applyObjectProperties() {
            updateObjectProperty();
            updateStatus('Properties applied');
        }
        
        // Action Dialog Functions
        function showActionDialog() {
            if (!selectedObject) {
                alert('Please select an object first');
                return;
            }
            document.getElementById('action-dialog').style.display = 'block';
        }
        
        function closeActionDialog() {
            document.getElementById('action-dialog').style.display = 'none';
        }
		
		function show3DSceneChooser() {
			// Cek apakah ada 3D scenes di project
			if (!sceneData.scene || !sceneData.scene.threedeescenes) {
				alert("No 3D scenes available");
				return;
			}
			
			let scenesHTML = '';
			sceneData.scene.threedeescenes.forEach((scene, index) => {
				scenesHTML += `
					<div onclick="addActionWith3DScene('${scene.id}')" 
						 style="display: block; margin: 5px; padding: 10px; background-color: #2c3643; 
								cursor: pointer; border: 1px solid #eba576;">
						<strong>${scene.name}</strong>
						<div style="font-size: 11px; color: #eba576;">${scene.objects?.length || 0} objects</div>
					</div>
				`;
			});
			
			const dialogHTML = `
				<div class="action-dialog" style="display: block; width: 400px;">
					<h3 style="margin-top: 0; color: #eba576;">Choose 3D Scene</h3>
					<div style="max-height: 300px; overflow-y: auto;">
						${scenesHTML}
					</div>
					<div style="text-align: right; margin-top: 20px;">
						<button class="btn" onclick="document.getElementById('custom-dialog').remove()">
							<i class="fa fa-times"></i> Cancel
						</button>
					</div>
				</div>
			`;
			
			const dialogDiv = document.createElement('div');
			dialogDiv.id = 'custom-dialog';
			dialogDiv.innerHTML = dialogHTML;
			document.body.appendChild(dialogDiv);
		}

		function addActionWith3DScene(sceneId) {
			addActionToSelectedObject(5, `3dscene:${sceneId}`);
			document.getElementById('custom-dialog').remove();
		}
        
        function selectActionType(type) {
			pendingActionType = type;
			
			// Close the action dialog
			document.getElementById('action-dialog').style.display = 'none';
			
			console.log("Selected action type:", type);
			
			switch(type) {
				case 0: // Open Panorama
					showAssetChooser('panoramas', 'Choose Panorama', null);
					break;
				case 1: // Show Image
					showAssetChooser('images', 'Choose Image', null);
					break;
				case 2: // Play Video
					showAssetChooser('videos', 'Choose Video', null);
					break;
				case 3: // Play Audio
					showAssetChooser('audios', 'Choose Audio', null);
					break;
				case 4: // Open PDF
					showAssetChooser('pdf', 'Choose PDF', null);
					break;
				case 5: // Open 3D Scene
					show3DSceneChooser();
					break;
				case 6: // Open URL
					showURLInput();
					break;
				case 7: // Execute JavaScript
					showJSInput();
					break;
				default:
					alert('Action type not implemented yet');
					pendingActionType = null;
			}
		}
        
        function showAssetChooser(assetType, title, callback) {
			// Tentukan ekstensi yang diizinkan
			let extensions = [];
			if (assetType === 'images' || assetType === 'panoramas') {
				extensions = ['jpg', 'jpeg', 'png', 'gif'];
			} else if (assetType === 'videos') {
				extensions = ['mp4', 'webm', 'ogg'];
			} else if (assetType === 'audios') {
				extensions = ['mp3', 'wav', 'ogg'];
			} else if (assetType === 'pdf') {
				extensions = ['pdf'];
			}
			
			// Tentukan direktori tujuan
			let targetDir;
			if (assetType === 'panoramas') {
				targetDir = projectDir + '/panoramas/';
			} else if (assetType === 'images') {
				targetDir = projectDir + '/images/';
			} else if (assetType === 'videos') {
				targetDir = projectDir + '/videos/';
			} else if (assetType === 'audios') {
				targetDir = projectDir + '/audios/';
			} else if (assetType === 'pdf') {
				targetDir = projectDir + '/pdf/';
			}
			
			// Baca file dari direktori
			if (!fs.existsSync(targetDir)) {
				fse.ensureDirSync(targetDir);
			}
			
			let itemsHTML = '';
			const files = fs.readdirSync(targetDir);
			
			files.forEach(file => {
				const ext = file.split('.').pop().toLowerCase();
				if (extensions.includes(ext)) {
					let icon = '';
					if (assetType === 'panoramas' || assetType === 'images') {
						icon = `<img src="file://${targetDir}${file}" style="height: 60px; max-width: 80px; object-fit: cover;">`;
					} else if (assetType === 'videos') {
						icon = '<i class="fa fa-film" style="font-size: 40px;"></i>';
					} else if (assetType === 'audios') {
						icon = '<i class="fa fa-music" style="font-size: 40px;"></i>';
					} else if (assetType === 'pdf') {
						icon = '<i class="fa fa-file-pdf-o" style="font-size: 40px;"></i>';
					}
					
					itemsHTML += `
						<div onclick="selectAssetFile('${assetType}', '${file}')" 
							 style="display: inline-block; width: 120px; margin: 5px; padding: 10px; 
									background-color: #2c3643; text-align: center; cursor: pointer; 
									border: 1px solid #eba576; vertical-align: top;">
							<div style="height: 60px; display: flex; align-items: center; justify-content: center;">
								${icon}
							</div>
							<div style="font-size: 11px; margin-top: 5px; word-break: break-all;">
								${file.length > 15 ? file.substr(0, 12) + '...' : file}
							</div>
						</div>
					`;
				}
			});
			
			if (itemsHTML === '') {
				itemsHTML = '<p style="color: #888; text-align: center; padding: 20px;">No files found in ' + assetType + ' folder.</p>';
			}
			
			// Hapus dialog sebelumnya jika ada
			const oldDialog = document.getElementById('custom-dialog');
			if (oldDialog) oldDialog.remove();
			
			// Tampilkan dialog
			const dialogHTML = `
				<div id="custom-dialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
					  background-color: rgba(0,0,0,0.7); display: flex; align-items: center; 
					  justify-content: center; z-index: 1000;">
					<div style="background-color: #232c37; border: 2px solid #eba576; width: 600px; 
						  max-width: 90vw; max-height: 80vh; overflow-y: auto; padding: 20px;">
						<h3 style="margin-top: 0; color: #eba576;">${title}</h3>
						<div style="max-height: 400px; overflow-y: auto; padding: 10px; background-color: #1e262f;">
							${itemsHTML}
						</div>
						<div style="text-align: right; margin-top: 20px;">
							<button class="btn" onclick="document.getElementById('custom-dialog').remove();">
								<i class="fa fa-times"></i> Cancel
							</button>
						</div>
					</div>
				</div>
			`;
			
			// Store callback temporarily
			window.pendingAssetCallback = callback;
			window.pendingAssetType = assetType;
			
			document.body.insertAdjacentHTML('beforeend', dialogHTML);
		}
        
        function selectAssetFile(assetType, filename) {
            // If this is a callback (for texture selection)
            if (window.pendingAssetCallback) {
                window.pendingAssetCallback(filename);
                window.pendingAssetCallback = null;
                document.getElementById('custom-dialog').remove();
                return;
            }
            
            // Otherwise, this is for action creation
            if (pendingActionType === undefined || pendingActionType === null) {
				console.error("No action type selected");
				alert("Please select an action type first");
				document.getElementById('custom-dialog')?.remove();
				pendingActionType = null;
				return;
			}
			
			// Untuk Open Panorama (type 0), simpan hanya nama file, tanpa folder
			let targetPath;
			if (pendingActionType === 0) {
				// Untuk panorama, simpan hanya nama file
				targetPath = filename;
			} else {
				// Untuk asset lain, simpan dengan folder
				targetPath = `${assetType}/${filename}`;
			}
			
			// Validasi: untuk Open Panorama (type 0), harus dari folder panoramas
			if (pendingActionType === 0 && assetType !== 'panoramas') {
				alert("For Open Panorama action, please select a file from the panoramas folder");
				return;
			}
			
			// Validasi untuk tipe lain
			if (pendingActionType === 1 && assetType !== 'images') {
				alert("For Show Image action, please select a file from the images folder");
				return;
			}
			
			if (pendingActionType === 2 && assetType !== 'videos') {
				alert("For Play Video action, please select a file from the videos folder");
				return;
			}
			
			if (pendingActionType === 3 && assetType !== 'audios') {
				alert("For Play Audio action, please select a file from the audios folder");
				return;
			}
			
			if (pendingActionType === 4 && assetType !== 'pdf') {
				alert("For Open PDF action, please select a file from the pdf folder");
				return;
			}
			
			// Jika semua validasi lolos, tambahkan action
			addActionToSelectedObject(pendingActionType, targetPath);
			
			// Hapus dialog dan reset pendingActionType
			document.getElementById('custom-dialog').remove();
			pendingActionType = null;
        }
        
        function showURLInput() {
            const dialogHTML = `
                <div class="action-dialog" style="display: block;">
                    <h3 style="margin-top: 0; color: #eba576;">Open URL</h3>
                    <p>Enter URL:</p>
                    <input type="text" id="url-input" placeholder="https://example.com" style="width: 100%; padding: 8px; margin: 10px 0;">
                    <div style="text-align: right;">
                        <button class="btn" onclick="document.getElementById('custom-dialog').remove()">Cancel</button>
                        <button class="btn btn-green" onclick="addURLAction()">Add Action</button>
                    </div>
                </div>
            `;
            
            const dialogDiv = document.createElement('div');
            dialogDiv.id = 'custom-dialog';
            dialogDiv.innerHTML = dialogHTML;
            document.body.appendChild(dialogDiv);
            
            setTimeout(() => document.getElementById('url-input').focus(), 100);
        }
        
        function addURLAction() {
            const url = document.getElementById('url-input').value.trim();
            if (url) {
                addActionToSelectedObject(6, url);
            }
            document.getElementById('custom-dialog').remove();
        }
        
        function showJSInput() {
            const dialogHTML = `
                <div class="action-dialog" style="display: block;">
                    <h3 style="margin-top: 0; color: #eba576;">JavaScript Code</h3>
                    <p>Enter JavaScript code:</p>
                    <textarea id="js-input" rows="5" style="width: 100%; padding: 8px; margin: 10px 0; background: #1e262f; color: white; border: 1px solid #3d4855;"></textarea>
                    <div style="text-align: right;">
                        <button class="btn" onclick="document.getElementById('custom-dialog').remove()">Cancel</button>
                        <button class="btn btn-green" onclick="addJSAction()">Add Action</button>
                    </div>
                </div>
            `;
            
            const dialogDiv = document.createElement('div');
            dialogDiv.id = 'custom-dialog';
            dialogDiv.innerHTML = dialogHTML;
            document.body.appendChild(dialogDiv);
            
            setTimeout(() => document.getElementById('js-input').focus(), 100);
        }
        
        function addJSAction() {
            const jsCode = document.getElementById('js-input').value.trim();
            if (jsCode) {
                addActionToSelectedObject(7, jsCode);
            }
            document.getElementById('custom-dialog').remove();
        }
        
        function addActionToSelectedObject(type, target) {
			if (!selectedObject) {
				alert("No object selected");
				pendingActionType = null;
				return;
			}
			
			// Inisialisasi array actions jika belum ada
			if (!selectedObject.userData.actions) {
				selectedObject.userData.actions = [];
			}
			
			// Tambahkan action baru
			selectedObject.userData.actions.push({
				type: type,
				target: target
			});
			
			console.log("Action added:", {
				type: type,
				target: target,
				actions: selectedObject.userData.actions
			});
			
			updateActionsList();
			updateObjectDataFromMesh(selectedObject);
			updateStatus('Action added');
		}
        
        function onKeyDown(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key.toLowerCase()) {
                    case 's':
                        event.preventDefault();
                        saveScene();
                        break;
                    case 'w':
                        event.preventDefault();
                        closeEditor();
                        break;
                }
                return;
            }
            
            // Mode shortcuts
            switch(event.key) {
                case 'q': setMode('move'); break;
                case 'w': setMode('rotate'); break;
                case 'e': setMode('scale'); break;
                case 'Delete':
                    if (selectedObject) deleteSelectedObject();
                    break;
            }
            
            // Snap modifier
            if (event.key === 'Control') {
                document.getElementById('gizmo-snap').classList.add('active');
            }
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            controls.update();
            renderer.render(scene, camera);
        }
        
        function saveScene() {
            // Update camera position
            sceneData.scene.cameraPos = {
                x: camera.position.x,
                y: camera.position.y,
                z: camera.position.z
            };
            
            // Save to temp file
            fs.writeFileSync(tempDataFile, JSON.stringify(sceneData));
            
            updateStatus('Scene saved!');
            
            // Flash effect
            document.body.style.backgroundColor = '#0d9e59';
            setTimeout(() => {
                document.body.style.backgroundColor = '';
            }, 200);
        }
        
        function closeEditor() {
            // Auto-save before closing
            saveScene();
            
            // Close window
            const { remote } = require('electron');
            const win = remote.getCurrentWindow();
            win.close();
        }
        
        function updateStatus(text) {
            document.getElementById('status-text').innerText = text;
        }
        
        // Start everything
        window.onload = init;
    </script>
</body>
</html>